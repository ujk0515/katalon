<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸª í…ŒìŠ¤íŠ¸ ëª©ì  ì„¤ëª… ìƒì„±ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; max-width: 800px; margin: auto; }
    input, button { width: 100%; margin-top: 10px; padding: 10px; font-size: 16px; }
    .download-buttons { display: flex; gap: 10px; margin-top: 15px; }
    .download-buttons button { width: 48%; }
    #output { margin-top: 20px; font-weight: bold; background: #f0f0f0; padding: 15px; border-radius: 6px; white-space: pre-line; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h2>ğŸª í…ŒìŠ¤íŠ¸ ëª©ì  ì„¤ëª… ìƒì„±ê¸° (ì—‘ì…€ ì—…ë¡œë“œ ê¸°ë°˜)</h2>
  <input type="file" id="excelFile" accept=".xlsx">

  <button onclick="handleFile()">âœ… í…ŒìŠ¤íŠ¸ ëª©ì  ë¬¸ì¥ ìƒì„±</button>
  
  <div id="downloadSection" class="hidden">
    <div class="download-buttons">
      <button onclick="downloadTxt()">ğŸ“„ TXT íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
  
  <div id="output"></div>

  <script>
    let generatedData = []; // ìƒì„±ëœ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´

    function cleanText(text) {
      return text.replace(/\d+\.?\s*/g, '').trim();
    }

    function handleFile() {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) {
        document.getElementById('output').innerText = 'ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: true });

        let outputText = '';
        generatedData = []; // ë°ì´í„° ì´ˆê¸°í™”

        json.forEach((row, index) => {
          const summary = cleanText(row['Summary'] || '');
          let preconditionRaw = row['Precondition'] || '';
          let precondition = preconditionRaw
            .split(/\r?\n/)                    // ì¤„ë°”ê¿ˆ ê¸°ì¤€ ë¶„ë¦¬
            .map(item => cleanText(item))       // ìˆ«ì ì ‘ë‘ì–´ ì œê±°
            .filter(Boolean)                    // ë¹ˆ í•­ëª© ì œê±°
            .join(', ');                        // ì‰¼í‘œë¡œ ì—°ê²°

          const expected = cleanText(row['Expected Result'] || '');

          if (summary && expected) {
            let sentence = '';
            if (precondition) {
              sentence = `${precondition} ìƒí™©ì—ì„œ, "${summary}"ì„(ë¥¼) ìˆ˜í–‰í•˜ì—¬ ${expected}`;
            } else {
              sentence = `"${summary}"ì„(ë¥¼) ìˆ˜í–‰í•˜ì—¬ ${expected}`;
            }
            
            // ë‹¤ìš´ë¡œë“œìš© ë°ì´í„° ì €ì¥
            generatedData.push({
              ë²ˆí˜¸: index + 1,
              í…ŒìŠ¤íŠ¸ëª©ì : sentence,
              ì›ë³¸_Summary: summary,
              ì›ë³¸_Precondition: precondition,
              ì›ë³¸_ExpectedResult: expected
            });
            
            outputText += `âœ… [${index + 1}] ${sentence}\n\n`;
          }
        });

        const outputElement = document.getElementById('output');
        const downloadSection = document.getElementById('downloadSection');
        
        if (outputText) {
          outputElement.innerText = outputText;
          downloadSection.classList.remove('hidden'); // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
        } else {
          outputElement.innerText = 'ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Summary, Precondition, Expected Result ì—´ì´ ëª¨ë‘ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.';
          downloadSection.classList.add('hidden'); // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€
        }
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function downloadTxt() {
      if (generatedData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      let txtContent = 'í…ŒìŠ¤íŠ¸ ëª©ì  ì„¤ëª… ëª©ë¡\n';
      txtContent += '=' + '='.repeat(30) + '\n\n';
      
      generatedData.forEach(item => {
        txtContent += `[${item.ë²ˆí˜¸}] ${item.í…ŒìŠ¤íŠ¸ëª©ì }\n\n`;
      });

      const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `í…ŒìŠ¤íŠ¸ëª©ì ì„¤ëª…_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadExcel() {
      if (generatedData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì—‘ì…€ìš© ë°ì´í„° ì¤€ë¹„
      const excelData = generatedData.map(item => ({
        'ë²ˆí˜¸': item.ë²ˆí˜¸,
        'í…ŒìŠ¤íŠ¸ ëª©ì ': item.í…ŒìŠ¤íŠ¸ëª©ì ,
        'ì›ë³¸ Summary': item.ì›ë³¸_Summary,
        'ì›ë³¸ Precondition': item.ì›ë³¸_Precondition,
        'ì›ë³¸ Expected Result': item.ì›ë³¸_ExpectedResult
      }));

      // ì›Œí¬ë¶ ìƒì„±
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'í…ŒìŠ¤íŠ¸ëª©ì ì„¤ëª…');

      // ì—´ ë„ˆë¹„ ì¡°ì •
      const colWidths = [
        { wch: 8 },   // ë²ˆí˜¸
        { wch: 60 },  // í…ŒìŠ¤íŠ¸ ëª©ì 
        { wch: 30 },  // ì›ë³¸ Summary
        { wch: 30 },  // ì›ë³¸ Precondition
        { wch: 30 }   // ì›ë³¸ Expected Result
      ];
      ws['!cols'] = colWidths;

      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      const fileName = `í…ŒìŠ¤íŠ¸ëª©ì ì„¤ëª…_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }
  </script>

</body>
</html>