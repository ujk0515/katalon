<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“„ TC Excel/CSV ë³‘í•©/ë¶„ë¦¬ ë„êµ¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; }
    input, button { margin-right: 10px; margin-bottom: 15px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .tab-buttons button { margin-right: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f0f0f0; }
    .file-info { margin: 10px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px; }
    .tab-description { 
      background-color: #e3f2fd; 
      padding: 10px; 
      border-radius: 5px; 
      margin-bottom: 15px; 
      border-left: 4px solid #2196f3; 
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ Test Case Excel/CSV ë³‘í•© / ë¶„ë¦¬ ë„êµ¬</h2>
<input type="file" id="fileInput" accept=".xlsx,.csv" />
<div class="file-info" id="fileInfo" style="display: none;"></div>
<div class="file-info" id="cleaningInfo" style="display: none; background-color: #e8f5e8; border-left: 4px solid #4caf50;">
  ğŸ§¹ HTML íƒœê·¸ ì •ë¦¬ ì™„ë£Œ! íƒœê·¸ë“¤ì´ ì ì ˆíˆ ë³€í™˜/ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>

<div class="tab-buttons">
  <button onclick="switchTab('merge')">ğŸ“¦ ë³‘í•© íƒ­</button>
  <button onclick="switchTab('split')">ğŸ” ë¶„ë¦¬ íƒ­</button>
</div>

<div id="mergeTab" class="tab active">
  <div class="tab-description">
    ğŸ“¦ <strong>ë³‘í•© íƒ­</strong>: CSV íŒŒì¼ì˜ Step 1~6 ì»¬ëŸ¼ë“¤ì„ Combined Stepsë¡œ ë³‘í•©í•©ë‹ˆë‹¤.
  </div>
  <button onclick="renderMerged()">ğŸ“¦ ë³‘í•© ì‹¤í–‰</button>
  <button onclick="downloadExcel('merged')">â¬‡ ë³‘í•©ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
  <div id="mergedTable"></div>
</div>

<div id="splitTab" class="tab">
  <div class="tab-description">
    ğŸ” <strong>ë¶„ë¦¬ íƒ­</strong>: ì—‘ì…€ íŒŒì¼ì˜ Combined Stepsë¥¼ Step 1~6 ì»¬ëŸ¼ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
  </div>
  <button onclick="renderSplit()">ğŸ” ë¶„ë¦¬ ì‹¤í–‰</button>
  <button onclick="downloadExcel('split')">â¬‡ ë¶„ë¦¬ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
  <div id="splitTable"></div>
</div>

<script>
let globalJson = [];
let mergedExport = [];
let splitExport = [];
let currentFileType = '';

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');
}

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const fileInfo = document.getElementById('fileInfo');
  fileInfo.innerHTML = `ğŸ“ íŒŒì¼: ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
  fileInfo.style.display = 'block';
  
  // ì •ë¦¬ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
  const cleaningInfo = document.getElementById('cleaningInfo');
  cleaningInfo.style.display = 'block';
  
  const fileExtension = file.name.split('.').pop().toLowerCase();
  currentFileType = fileExtension;
  
  if (fileExtension === 'csv') {
    // CSV íŒŒì¼ ì²˜ë¦¬
    const reader = new FileReader();
    reader.onload = function(evt) {
      const csvText = evt.target.result;
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        complete: function(results) {
          globalJson = results.data.map(row => {
            const cleanedRow = {};
            Object.keys(row).forEach(key => {
              let value = row[key];
              if (typeof value === 'string') {
                value = cleanHtmlTags(value);
              }
              cleanedRow[key] = value;
            });
            return cleanedRow;
          });
          // CSV íŒŒì¼ì´ë¯€ë¡œ ë³‘í•© íƒ­ë§Œ ìë™ ë Œë”ë§
          renderMerged();
        }
      });
    };
    reader.readAsText(file, 'utf-8');
  } else {
    // Excel íŒŒì¼ ì²˜ë¦¬
    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawJson = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false });
      globalJson = rawJson.map(row => {
        const cleanedRow = {};
        Object.keys(row).forEach(key => {
          let value = row[key];
          if (typeof value === 'string') {
            value = cleanHtmlTags(value);
          }
          cleanedRow[key] = value;
        });
        return cleanedRow;
      });
      // ì—‘ì…€ íŒŒì¼ì´ë¯€ë¡œ ë¶„ë¦¬ íƒ­ë§Œ ìë™ ë Œë”ë§
      renderSplit();
    };
    reader.readAsArrayBuffer(file);
  }
});

function preserveLineBreaks(text) {
  return (text || '').toString().replace(/\n/g, '<br>');
}

function cleanHtmlTags(text) {
  if (!text || typeof text !== 'string') return text;
  
  let cleanedText = text;
  
  // 1. ì¤„ë°”ê¿ˆ ê´€ë ¨ íƒœê·¸ë“¤ì„ \nìœ¼ë¡œ ë³€í™˜
  cleanedText = cleanedText
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<\/?(p|div|h[1-6]|li|tr)[^>]*>/gi, '\n')
    .replace(/<\/?(ul|ol|table|tbody|thead)[^>]*>/gi, '\n');
  
  // 2. í…ìŠ¤íŠ¸ ì„œì‹ íƒœê·¸ë“¤ ì²˜ë¦¬ (ì—‘ì…€ì—ì„œëŠ” ì„œì‹ì´ ìœ ì§€ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë‚´ìš©ë§Œ ìœ ì§€)
  // ê°•ì¡° íƒœê·¸ë“¤ (êµµê²Œ, ê¸°ìš¸ì„, ë°‘ì¤„ ë“±)
  cleanedText = cleanedText
    .replace(/<\/?(?:b|strong)[^>]*>/gi, '')
    .replace(/<\/?(?:i|em)[^>]*>/gi, '')
    .replace(/<\/?u[^>]*>/gi, '')
    .replace(/<\/?s[^>]*>/gi, '');
  
  // 3. ë§í¬ íƒœê·¸ ì²˜ë¦¬ - ë§í¬ í…ìŠ¤íŠ¸ë§Œ ìœ ì§€í•˜ê±°ë‚˜ URLë„ í‘œì‹œ
  cleanedText = cleanedText.replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, (match, url, text) => {
    // ë§í¬ í…ìŠ¤íŠ¸ì™€ URLì´ ë‹¤ë¥¸ ê²½ìš° ë‘˜ ë‹¤ í‘œì‹œ
    if (text.trim() && text.trim().toLowerCase() !== url.trim().toLowerCase()) {
      return `${text.trim()} (${url.trim()})`;
    }
    // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ URLë§Œ í‘œì‹œ
    return url.trim() || text.trim();
  });
  
  // 4. ì´ë¯¸ì§€ íƒœê·¸ ì²˜ë¦¬ - alt í…ìŠ¤íŠ¸ë‚˜ src ì •ë³´ ìœ ì§€
  cleanedText = cleanedText.replace(/<img[^>]*alt=["']([^"']*)["'][^>]*>/gi, '[ì´ë¯¸ì§€: $1]');
  cleanedText = cleanedText.replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '[ì´ë¯¸ì§€: $1]');
  cleanedText = cleanedText.replace(/<img[^>]*>/gi, '[ì´ë¯¸ì§€]');
  
  // 5. í…Œì´ë¸” ê´€ë ¨ íƒœê·¸ ì²˜ë¦¬
  cleanedText = cleanedText.replace(/<\/?t[hd][^>]*>/gi, ' | '); // í…Œì´ë¸” ì…€ì„ êµ¬ë¶„ìë¡œ
  
  // 6. ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ íƒœê·¸ ì²˜ë¦¬
  cleanedText = cleanedText.replace(/<li[^>]*>/gi, 'â€¢ '); // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì„ ë¶ˆë¦¿ìœ¼ë¡œ
  
  // 7. í¼ ê´€ë ¨ íƒœê·¸ë“¤ ë‚´ìš© ìœ ì§€
  cleanedText = cleanedText.replace(/<input[^>]*value=["']([^"']*)["'][^>]*>/gi, '[$1]');
  cleanedText = cleanedText.replace(/<textarea[^>]*>(.*?)<\/textarea>/gi, '[$1]');
  cleanedText = cleanedText.replace(/<select[^>]*>.*?<\/select>/gi, '[ì„ íƒì˜µì…˜]');
  
  // 8. ì½”ë“œ ê´€ë ¨ íƒœê·¸ ì²˜ë¦¬
  cleanedText = cleanedText.replace(/<\/?(?:code|pre|kbd)[^>]*>/gi, '`');
  
  // 9. ì¸ìš©ë¬¸ ì²˜ë¦¬
  cleanedText = cleanedText.replace(/<\/?(?:blockquote|q)[^>]*>/gi, '"');
  
  // 10. ë‚˜ë¨¸ì§€ ëª¨ë“  HTML íƒœê·¸ ì œê±° (ìŠ¤íƒ€ì¼, ìŠ¤í¬ë¦½íŠ¸, ê¸°íƒ€ íƒœê·¸ë“¤)
  cleanedText = cleanedText.replace(/<script[^>]*>.*?<\/script>/gis, '');
  cleanedText = cleanedText.replace(/<style[^>]*>.*?<\/style>/gis, '');
  cleanedText = cleanedText.replace(/<[^>]+>/g, '');
  
  // 11. HTML ì—”í‹°í‹° ë””ì½”ë”©
  cleanedText = cleanedText
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&nbsp;/g, ' ')
    .replace(/&copy;/g, 'Â©')
    .replace(/&reg;/g, 'Â®')
    .replace(/&trade;/g, 'â„¢');
  
  // 12. ì—°ì†ëœ ê³µë°±ê³¼ ì¤„ë°”ê¿ˆ ì •ë¦¬
  cleanedText = cleanedText
    .replace(/\n\s*\n\s*\n/g, '\n\n') // 3ê°œ ì´ìƒì˜ ì—°ì† ì¤„ë°”ê¿ˆì„ 2ê°œë¡œ
    .replace(/[ \t]+/g, ' ') // ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ
    .replace(/^\s+|\s+$/g, '') // ì•ë’¤ ê³µë°± ì œê±°
    .replace(/\n\s+/g, '\n') // ì¤„ë°”ê¿ˆ í›„ ê³µë°± ì œê±°
    .replace(/\s+\n/g, '\n'); // ì¤„ë°”ê¿ˆ ì „ ê³µë°± ì œê±°
  
  return cleanedText;
}

function addNumberingToText(text) {
  if (!text || !text.toString().trim()) return text;
  
  const textStr = text.toString().trim();
  // ì´ë¯¸ ë²ˆí˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸
  if (/^1\.\s/.test(textStr)) {
    return textStr;
  }
  
  return `1. ${textStr}`;
}

function addLineNumbering(text) {
  if (!text || !text.toString().trim()) return text;

  const lines = text.toString().trim().split('\n').filter(line => line.trim() !== '');
  return lines.map((line, index) => `${index + 1}. ${line.trim()}`).join('\n');
}

function renderMerged() {
  if (currentFileType !== 'csv') {
    document.getElementById('mergedTable').innerHTML = '<p style="color: #ff6b6b; padding: 20px;">âš ï¸ ë³‘í•© íƒ­ì€ CSV íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤. CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
    return;
  }

  mergedExport = [];
  let html = `<table><thead><tr>
    <th>Folder</th><th>Main Category</th><th>Sub Category</th><th>Detail Category</th>
    <th>TC Summary</th><th>Precondition</th><th>Test Level</th>
    <th>Expected Result</th><th>Combined Steps</th>
  </tr></thead><tbody>`;

  globalJson.forEach((row, index) => {
    let combinedSteps = '';
    const stepLikeKeys = Object.keys(row).filter(k => k.toLowerCase().replace(/\s+/g, '') === 'steps(step)');
    if (stepLikeKeys.length > 0) {
      const key = stepLikeKeys[0];
      if (row[key] && row[key].toString().trim()) {
        combinedSteps += row[key].toString().trim() + '\n';
      }
    }
    let stepIndex = 1;
    for (let i = 1; i <= 6; i++) {
      const key = `Step ${i} (Step ${i})`;
      if (row[key] && row[key].trim()) {
        combinedSteps += `${stepIndex++}. ${row[key].trim()}\n`;
      }
    }
    
    // Combined Stepsì— ë²ˆí˜¸ ì¶”ê°€ (ì›ë³¸ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸)
    const cleanedCombinedSteps = combinedSteps.trim();
    const numberedCombinedSteps = addLineNumbering(cleanedCombinedSteps);
    
    // globalJsonì—ë„ Combined Steps ê°’ì„ ì €ì¥í•˜ì—¬ ë¶„ë¦¬ íƒ­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•¨
    globalJson[index]['Combined Steps'] = numberedCombinedSteps;
    
    // Expected Resultì— ë²ˆí˜¸ ì¶”ê°€
    const expectedResult = row['Expected Result (Expected Result)'] || row['Expected Result'] || '';
    const numberedExpectedResult = addNumberingToText(expectedResult);
    
    mergedExport.push({
      'Folder': row['Folder'],
      'Main Category': row['Main Category'],
      'Sub Category': row['Sub Category'],
      'Detail Category': row['Detail Category'],
      'TC Summary': row['TC Summary'],
      'Precondition': row['Precondition'],
      'Test Level': row['Test Level'],
      'Expected Result': numberedExpectedResult,
      'Combined Steps': numberedCombinedSteps
    });
    
    html += `<tr>
      <td>${preserveLineBreaks(row['Folder'])}</td><td>${preserveLineBreaks(row['Main Category'])}</td>
      <td>${preserveLineBreaks(row['Sub Category'])}</td><td>${preserveLineBreaks(row['Detail Category'])}</td>
      <td>${preserveLineBreaks(row['TC Summary'])}</td><td>${preserveLineBreaks(row['Precondition'])}</td>
      <td>${preserveLineBreaks(row['Test Level'])}</td><td>${preserveLineBreaks(numberedExpectedResult)}</td>
      <td>${preserveLineBreaks(numberedCombinedSteps)}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('mergedTable').innerHTML = html;
}

function splitCombinedSteps(combinedStepsText) {
  if (!combinedStepsText || !combinedStepsText.toString().trim()) {
    return Array(7).fill(''); // Steps (Step), Step 1~6
  }

  const text = combinedStepsText.toString().trim();
  const steps = Array(7).fill('');
  
  // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ê° ë¼ì¸ì„ ì²˜ë¦¬
  const lines = text.split(/\n/).map(line => line.trim()).filter(line => line.length > 0);
  
  if (lines.length === 0) return steps;
  
  console.log('Combined Steps ë¶„ë¦¬ ì²˜ë¦¬:', text);
  console.log('ë¼ì¸ë“¤:', lines);
  
  // ê° ë¼ì¸ì„ ìˆœíšŒí•˜ë©´ì„œ ì²˜ë¦¬
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” íŒ¨í„´ ì°¾ê¸° (1., 2., 3. ë“±)
    const numberMatch = line.match(/^(\d+)\.\s*(.*)$/);
    
    if (numberMatch) {
      const stepNumber = parseInt(numberMatch[1]);
      const stepContent = numberMatch[2].trim();
      
      console.log(`ìŠ¤í… ${stepNumber} ë°œê²¬:`, stepContent);
      
      if (stepNumber === 1) {
        // 1ë²ˆì€ Steps (Step)ì— í• ë‹¹
        steps[0] = stepContent;
        console.log('Steps (Step)ì— í• ë‹¹:', stepContent);
      } else if (stepNumber >= 2 && stepNumber <= 7) {
        // 2ë²ˆì€ Step 1, 3ë²ˆì€ Step 2, ..., 7ë²ˆì€ Step 6
        steps[stepNumber - 1] = stepContent;
        console.log(`Step ${stepNumber - 1}ì— í• ë‹¹:`, stepContent);
      }
    } else {
      // ìˆ«ìë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°ëŠ” ë¬´ì‹œí•˜ê±°ë‚˜ ì²« ë²ˆì§¸ ë¹ˆ ìë¦¬ì— í• ë‹¹
      if (steps[0] === '') {
        steps[0] = line;
        console.log('Steps (Step)ì— í• ë‹¹ (ë²ˆí˜¸ ì—†ìŒ):', line);
      }
    }
  }
  
  console.log('ìµœì¢… ë¶„ë¦¬ ê²°ê³¼:', steps);
  return steps;
}

function renderSplit() {
  if (currentFileType !== 'xlsx') {
    document.getElementById('splitTable').innerHTML = '<p style="color: #ff6b6b; padding: 20px;">âš ï¸ ë¶„ë¦¬ íƒ­ì€ ì—‘ì…€ íŒŒì¼(.xlsx)ë§Œ ì§€ì›í•©ë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
    return;
  }

  splitExport = [];
  let html = `<table><thead><tr>
    <th>Folder</th><th>Main Category</th><th>Sub Category</th><th>Detail Category</th>
    <th>TC Summary</th><th>Precondition</th><th>Test Level</th>
    <th>Expected Result</th><th>Steps (Step)</th>
    <th>Step 1</th><th>Step 2</th><th>Step 3</th><th>Step 4</th><th>Step 5</th><th>Step 6</th>
  </tr></thead><tbody>`;

  globalJson.forEach(row => {
    // Combined Steps ì—´ì˜ ê°’ì„ ê°€ì ¸ì™€ì„œ ë¶„ë¦¬
    const combinedSteps = row['Combined Steps'] || '';
    const steps = splitCombinedSteps(combinedSteps);
    
    const expectedResult = row['Expected Result (Expected Result)'] || row['Expected Result'] || '';

    splitExport.push({
      'Folder': row['Folder'],
      'Main Category': row['Main Category'],
      'Sub Category': row['Sub Category'],
      'Detail Category': row['Detail Category'],
      'TC Summary': row['TC Summary'],
      'Precondition': row['Precondition'],
      'Test Level': row['Test Level'],
      'Expected Result': expectedResult,
      'Steps (Step)': steps[0],
      'Step 1': steps[1], 'Step 2': steps[2], 'Step 3': steps[3],
      'Step 4': steps[4], 'Step 5': steps[5], 'Step 6': steps[6],
    });

    html += `<tr>
      <td>${preserveLineBreaks(row['Folder'])}</td><td>${preserveLineBreaks(row['Main Category'])}</td>
      <td>${preserveLineBreaks(row['Sub Category'])}</td><td>${preserveLineBreaks(row['Detail Category'])}</td>
      <td>${preserveLineBreaks(row['TC Summary'])}</td><td>${preserveLineBreaks(row['Precondition'])}</td>
      <td>${preserveLineBreaks(row['Test Level'])}</td><td>${preserveLineBreaks(expectedResult)}</td>
      <td>${preserveLineBreaks(steps[0])}</td><td>${preserveLineBreaks(steps[1])}</td><td>${preserveLineBreaks(steps[2])}</td>
      <td>${preserveLineBreaks(steps[3])}</td><td>${preserveLineBreaks(steps[4])}</td><td>${preserveLineBreaks(steps[5])}</td><td>${preserveLineBreaks(steps[6])}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('splitTable').innerHTML = html;
}

function downloadExcel(type) {
  const wb = XLSX.utils.book_new();
  let ws;
  if (type === 'merged') {
    if (mergedExport.length === 0) {
      alert('ë³‘í•© ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë³‘í•©ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }
    ws = XLSX.utils.json_to_sheet(mergedExport);
    XLSX.utils.book_append_sheet(wb, ws, 'Merged Result');
    XLSX.writeFile(wb, 'merged_result.xlsx');
  } else {
    if (splitExport.length === 0) {
      alert('ë¶„ë¦¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ë¦¬ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }
    ws = XLSX.utils.json_to_sheet(splitExport);
    XLSX.utils.book_append_sheet(wb, ws, 'Split Result');
    XLSX.writeFile(wb, 'split_result.xlsx');
  }
}
</script>

</body>
</html>
