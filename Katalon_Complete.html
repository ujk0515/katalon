<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="UTF-8">
  <title>QA í†µí•© ìœ í‹¸ë¦¬í‹°</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
    }
    header {
      display: flex;
      background: #333;
      padding: 10px;
      justify-content: center;
    }
    .tab-button {
      background: #444;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      margin: 0 10px;
    }
    .tab-button.active {
      background: #00aaff;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .container {
      max-width: 100%;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .error {
      color: red;
      font-weight: bold;
    }
    table.dataTable td {
      white-space: normal !important;
      word-break: break-word !important;
      vertical-align: top !important;
      padding: 10px 12px !important;
      font-size: 14px;
      line-height: 1.6;
    }
    #resultTable_wrapper {
      overflow-x: auto;
    }
    table {
      width: 100% !important;
      table-layout: auto !important;
    }
    #reportChart {
      width: 500px !important;
      height: 500px !important;
      display: block;
      margin: 0 auto;
    }
    input[type="text"] {
      width: 400px;
      height: 15px;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 8px;
    }
    /* TC+Script íƒ­ ì „ìš© ìŠ¤íƒ€ì¼ */
    .tc-script-container {
      display: flex;
      gap: 20px;
      height: 70vh;
    }
    .tc-script-left {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }
    .tc-script-right {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }
    .tc-script-output {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .button-group button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .button-group button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
<header>
  <button class="tab-button active" data-tab="csv">CSV íŒŒì‹±</button>
  <button class="tab-button" data-tab="groovy">Groovy</button>
  <button class="tab-button" data-tab="tcscript">TC+Script</button>
  <button class="tab-button" data-tab="report">ê²°ê³¼ê°’ Report</button>
  <button class="tab-button" data-tab="folder">í´ë” ìƒì„±ê¸°</button>
</header>
<main>
  <div id="csv" class="tab-content active">
    <div class="container">
      <h2>ğŸ”ª WebUI.comment ê¸°ë°˜ ë©”íƒ€ë°ì´í„° íŒŒì„œ</h2>
      <input type="file" id="csvFile" accept=".csv">
      <button id="downloadBtn">â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button id="exampleDownloadBtn">ğŸ“¥ ì˜ˆì‹œíŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
      <div id="error" class="error"></div>
      <table id="resultTable" class="display" style="display:none;"></table>
    </div>
  </div>
  <div id="groovy" class="tab-content">
    <div class="container">
      <h2>ğŸ“„ Excel â” Katalon Test Case ë³€í™˜ê¸°</h2>
      <input type="file" id="excelFile" accept=".xlsx">
      <button onclick="generateAllZip('tc')">ì „ì²´ .tc ZIP ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="generateAllZip('groovy')">ì „ì²´ .groovy ZIP ë‹¤ìš´ë¡œë“œ</button>
      <div id="preview"></div>
    </div>
  </div>
  <div id="tcscript" class="tab-content">
    <div class="container">
      <h2>ğŸ”§ TC+Script í†µí•© ìƒì„±ê¸°</h2>
      <input type="file" id="tcScriptExcelFile" accept=".xlsx,.xls,.csv">
      <div class="button-group">
        <button onclick="generateTCScript()">ğŸ“‹ TC+Script ìƒì„±</button>
        <button onclick="downloadTCOnly()">ğŸ“„ TCë§Œ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadScriptOnly()">ğŸ”§ Scriptë§Œ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadMergedFiles()">ğŸ“¦ ë³‘í•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="clearTCScriptOutput()">ğŸ—‘ï¸ ê²°ê³¼ ì´ˆê¸°í™”</button>
      </div>
      <div class="tc-script-container">
        <div class="tc-script-left">
          <h3>ğŸ“Š ë§¤í•‘ ê²°ê³¼</h3>
          <div id="tcScriptMappingResult" class="tc-script-output">
            ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  TC+Script ìƒì„±ì„ í´ë¦­í•˜ë©´ ë§¤í•‘ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
        <div class="tc-script-right">
          <h3>ğŸ“„ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸</h3>
          <div id="tcScriptGeneratedCode" class="tc-script-output">
            ìƒì„±ëœ Katalon ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="report" class="tab-content">
    <div class="container">
      <h2>ğŸ§¾ HTML ê²°ê³¼ê°’ Report ë·°ì–´</h2>
      <input type="file" id="reportFileInput" accept=".html">
      <div style="display: flex; gap: 20px; height: 90vh;">
        <iframe id="reportPreview" style="width: 50%; height: 100%; border: 1px solid #ccc;"></iframe>
        <div id="reportResult" style="width: 50%; padding: 1em; overflow-y: auto; background: white;">
          <h2 style="color:#888">ğŸ“‹ íŒŒì‹±ëœ ë°ì´í„°ê°€ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤</h2>
        </div>
      </div>
    </div>
  </div>
  <div id="folder" class="tab-content">
    <div class="container">
      <div style="display: flex; align-items: center;">
        <h2 style="margin: 0 12px 0 0;">ğŸ“‚ í´ë” ZIP ìƒì„±ê¸° (ì—‘ì…€ ì—…ë¡œë“œ ì§€ì›)</h2>
        <button onclick="generateZip()">ğŸ“¦ ZIP ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <input type="file" id="excelInput" accept=".xlsx, .xls"><br><br>
      <div id="inputArea">
        <input type="text" placeholder="í´ë”ëª… ì…ë ¥">
      </div>
      <button onclick="addInput()">+ í´ë” ì¶”ê°€</button>
    </div>
  </div>
</main>
<script>
// ======= TC+Script í•¨ìˆ˜ë“¤ì„ ìµœìš°ì„ ìœ¼ë¡œ ì •ì˜ =======
var tcScriptData = [];
var tcScriptResults = [];

function generateTCScript() {
  console.log('âœ… generateTCScript í•¨ìˆ˜ í˜¸ì¶œ ì„±ê³µ!');
  console.log('í˜„ì¬ tcScriptData:', tcScriptData);
  console.log('tcScriptData ê¸¸ì´:', tcScriptData ? tcScriptData.length : 'undefined');
  
  // ë””ë²„ê¹… ì •ë³´ ì¶”ê°€
  if (tcScriptData) {
    console.log('ì²« ë²ˆì§¸ í–‰:', tcScriptData[0]);
    console.log('ë°ì´í„° íƒ€ì…:', typeof tcScriptData);
    console.log('ë°°ì—´ì¸ê°€?', Array.isArray(tcScriptData));
  }
  
  // ì‹¤ì œ ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
  if (!tcScriptData || !Array.isArray(tcScriptData) || tcScriptData.length === 0) {
    console.error('âŒ tcScriptData ë¬¸ì œ:', {
      exists: !!tcScriptData,
      isArray: Array.isArray(tcScriptData),
      length: tcScriptData ? tcScriptData.length : 'N/A'
    });
    
    alert('âš ï¸ ë°ì´í„° ë¡œë”© ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\n\nğŸ”§ í•´ê²° ë°©ë²•:\n1. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”\n2. ì—‘ì…€ íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ì„¸ìš”\n3. F12 â†’ Consoleì—ì„œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”');
    return;
  }
  
  console.log(`ğŸ“Š ì—…ë¡œë“œëœ ë°ì´í„°: ${tcScriptData.length}ê°œ í–‰`);
  console.log('ì²« ë²ˆì§¸ í–‰ ë°ì´í„°:', tcScriptData[0]);
  
  // ì‹¤ì œ ì—‘ì…€ ë°ì´í„°ë¡œ ë§¤í•‘ ìˆ˜í–‰
  processRealExcelData();
}

// ì‹¤ì œ ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (í”¼ë“œë°± ê°•í™”)
function processRealExcelData() {
  console.log('ğŸ”„ ì‹¤ì œ ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘...');
  
  // ë¨¼ì € ì»¬ëŸ¼ ë§¤í•‘ ë¶„ì„
  const columnAnalysis = analyzeColumns();
  
  let mappingResults = 'ğŸ“Š ì»¬ëŸ¼ ë§¤í•‘ ë¶„ì„ ê²°ê³¼:\n\n';
  mappingResults += columnAnalysis.report + '\n';
  mappingResults += '=' + '='.repeat(50) + '\n\n';
  mappingResults += 'ğŸ”„ ê°œë³„ í–‰ ì²˜ë¦¬ ê²°ê³¼:\n\n';
  
  let generatedCode = 'ğŸ“ ìƒì„±ëœ Katalon ìŠ¤í¬ë¦½íŠ¸:\n\n';
  let successCount = 0;
  let totalCount = tcScriptData.length;
  
  tcScriptData.forEach((row, idx) => {
    console.log(`ì²˜ë¦¬ ì¤‘ ${idx + 1}ë²ˆì§¸ í–‰:`, row);
    
    // ê°•í™”ëœ ì»¬ëŸ¼ ì¶”ì¶œ
    const extractResult = extractWithFeedback(row, columnAnalysis.mapping);
    const testName = extractResult.summary || `TestCase_${idx + 1}`;
    
    // í‚¤ì›Œë“œ ë§¤í•‘ ìˆ˜í–‰
    const mappingResult = performKeywordMapping(
      extractResult.summary, 
      extractResult.precondition, 
      extractResult.expectedResult
    );
    
    // ìƒì„¸ í”¼ë“œë°± ìƒì„±
    mappingResults += `ğŸ“‹ [${idx + 1}] ${testName}\n`;
    mappingResults += generateDetailedFeedback(extractResult, mappingResult);
    mappingResults += '\n';
    
    generatedCode += `// ========== [${idx + 1}] ${testName} ==========\n`;
    generatedCode += `${mappingResult.script}\n\n`;
    
    if (mappingResult.hasValidMapping) successCount++;
  });
  
  // ìš”ì•½ í†µê³„ ì¶”ê°€
  const summary = generateProcessingSummary(successCount, totalCount, columnAnalysis);
  mappingResults = summary + '\n' + mappingResults;
  
  // ê²°ê³¼ í‘œì‹œ
  displayResults(mappingResults, generatedCode);
}

// ì»¬ëŸ¼ ë¶„ì„ í•¨ìˆ˜
function analyzeColumns() {
  if (!tcScriptData || tcScriptData.length === 0) {
    return { mapping: {}, report: 'âŒ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' };
  }
  
  const firstRow = tcScriptData[0];
  const allColumns = Object.keys(firstRow);
  
  console.log('ğŸ” ê°ì§€ëœ ëª¨ë“  ì»¬ëŸ¼:', allColumns);
  
  const analysis = {
    summary: findBestMatch(allColumns, ['Summary', 'summary', 'ìš”ì•½', 'í…ŒìŠ¤íŠ¸ëª…', 'Test Name', 'TestName', 'ì œëª©']),
    precondition: findBestMatch(allColumns, ['Precondition', 'precondition', 'ì „ì œì¡°ê±´', 'ì‚¬ì „ì¡°ê±´', 'Pre-condition', 'PreCondition']),
    expectedResult: findBestMatch(allColumns, ['Expected Result', 'expected result', 'ExpectedResult', 'ì˜ˆìƒê²°ê³¼', 'ê¸°ëŒ€ê²°ê³¼', 'Expected', 'ê²°ê³¼'])
  };
  
  // ë§¤í•‘ ë³´ê³ ì„œ ìƒì„±
  let report = 'ğŸ” ì»¬ëŸ¼ ë§¤í•‘ ë¶„ì„:\n';
  report += `ğŸ“ ì „ì²´ ì»¬ëŸ¼ ìˆ˜: ${allColumns.length}ê°œ\n`;
  report += `ğŸ“‹ ê°ì§€ëœ ì»¬ëŸ¼: ${allColumns.join(', ')}\n\n`;
  
  report += 'ğŸ¯ ë§¤í•‘ ê²°ê³¼:\n';
  report += `Summary     : ${analysis.summary.status} ${analysis.summary.column ? `â†’ "${analysis.summary.column}"` : ''}\n`;
  report += `Precondition: ${analysis.precondition.status} ${analysis.precondition.column ? `â†’ "${analysis.precondition.column}"` : ''}\n`;
  report += `Expected    : ${analysis.expectedResult.status} ${analysis.expectedResult.column ? `â†’ "${analysis.expectedResult.column}"` : ''}\n`;
  
  // ë§¤í•‘ë˜ì§€ ì•Šì€ ì»¬ëŸ¼ í‘œì‹œ
  const unmappedColumns = allColumns.filter(col => 
    col !== analysis.summary.column && 
    col !== analysis.precondition.column && 
    col !== analysis.expectedResult.column
  );
  
  if (unmappedColumns.length > 0) {
    report += `\nğŸ“ ë§¤í•‘ë˜ì§€ ì•Šì€ ì»¬ëŸ¼: ${unmappedColumns.join(', ')}`;
  }
  
  return {
    mapping: {
      summary: analysis.summary.column,
      precondition: analysis.precondition.column,
      expectedResult: analysis.expectedResult.column
    },
    report: report,
    unmapped: unmappedColumns
  };
}

// ìµœì  ë§¤í•‘ ì°¾ê¸°
function findBestMatch(availableColumns, targetKeywords) {
  // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì»¬ëŸ¼ ì°¾ê¸°
  for (let keyword of targetKeywords) {
    for (let column of availableColumns) {
      if (column === keyword) {
        return { column: column, status: 'âœ… ì •í™• ë§¤í•‘', confidence: 100 };
      }
    }
  }
  
  // ë¶€ë¶„ ì¼ì¹˜í•˜ëŠ” ì»¬ëŸ¼ ì°¾ê¸°
  for (let keyword of targetKeywords) {
    for (let column of availableColumns) {
      if (column.toLowerCase().includes(keyword.toLowerCase()) || 
          keyword.toLowerCase().includes(column.toLowerCase())) {
        return { column: column, status: 'âš ï¸ ìœ ì‚¬ ë§¤í•‘', confidence: 70 };
      }
    }
  }
  
  return { column: null, status: 'âŒ ë§¤í•‘ ì‹¤íŒ¨', confidence: 0 };
}

// ê°•í™”ëœ ê°’ ì¶”ì¶œ
function extractWithFeedback(row, columnMapping) {
  const result = {
    summary: '',
    precondition: '',
    expectedResult: '',
    feedback: []
  };
  
  // Summary ì¶”ì¶œ
  if (columnMapping.summary) {
    result.summary = String(row[columnMapping.summary] || '').trim();
    result.feedback.push(`Summary: "${columnMapping.summary}" â†’ "${result.summary.substring(0, 30)}${result.summary.length > 30 ? '...' : ''}"`);
  } else {
    result.feedback.push('Summary: âŒ ë§¤í•‘ëœ ì»¬ëŸ¼ ì—†ìŒ');
  }
  
  // Precondition ì¶”ì¶œ
  if (columnMapping.precondition) {
    result.precondition = String(row[columnMapping.precondition] || '').trim();
    result.feedback.push(`Precondition: "${columnMapping.precondition}" â†’ "${result.precondition.substring(0, 30)}${result.precondition.length > 30 ? '...' : ''}"`);
  } else {
    result.feedback.push('Precondition: âŒ ë§¤í•‘ëœ ì»¬ëŸ¼ ì—†ìŒ');
  }
  
  // Expected Result ì¶”ì¶œ
  if (columnMapping.expectedResult) {
    result.expectedResult = String(row[columnMapping.expectedResult] || '').trim();
    result.feedback.push(`Expected: "${columnMapping.expectedResult}" â†’ "${result.expectedResult.substring(0, 30)}${result.expectedResult.length > 30 ? '...' : ''}"`);
  } else {
    result.feedback.push('Expected: âŒ ë§¤í•‘ëœ ì»¬ëŸ¼ ì—†ìŒ');
  }
  
  return result;
}

// ìƒì„¸ í”¼ë“œë°± ìƒì„±
function generateDetailedFeedback(extractResult, mappingResult) {
  let feedback = '';
  
  // ë°ì´í„° ì¶”ì¶œ í”¼ë“œë°±
  feedback += '  ğŸ“Š ë°ì´í„° ì¶”ì¶œ:\n';
  extractResult.feedback.forEach(fb => {
    feedback += `    ${fb}\n`;
  });
  
  // í‚¤ì›Œë“œ ë§¤í•‘ í”¼ë“œë°±
  feedback += '  ğŸ” í‚¤ì›Œë“œ ë§¤í•‘:\n';
  if (mappingResult.hasValidMapping) {
    feedback += `    âœ… ì„±ê³µ: ${mappingResult.successCount || 1}ê°œ í‚¤ì›Œë“œ ë§¤í•‘ë¨\n`;
  } else {
    feedback += '    âŒ ì‹¤íŒ¨: ë§¤í•‘ ê°€ëŠ¥í•œ í‚¤ì›Œë“œ ì—†ìŒ\n';
    feedback += '    ğŸ’¡ ì§€ì› í‚¤ì›Œë“œ: í´ë¦­, ì…ë ¥, í™•ì¸, ì´ë™, ì„ íƒ, ì²´í¬\n';
  }
  
  return feedback;
}

// ì²˜ë¦¬ ìš”ì•½ ìƒì„±
function generateProcessingSummary(successCount, totalCount, columnAnalysis) {
  const successRate = totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0;
  
  let summary = 'ğŸ“ˆ ì²˜ë¦¬ ìš”ì•½ ë³´ê³ ì„œ\n';
  summary += '=' + '='.repeat(30) + '\n';
  summary += `âœ… ì„±ê³µ: ${successCount}/${totalCount} (${successRate}%)\n`;
  summary += `âŒ ì‹¤íŒ¨: ${totalCount - successCount}/${totalCount} (${100 - successRate}%)\n`;
  
  // ë§¤í•‘ í’ˆì§ˆ í‰ê°€
  const mappedColumns = Object.values(columnAnalysis.mapping).filter(col => col).length;
  const totalRequiredColumns = 3; // Summary, Precondition, Expected Result
  const mappingQuality = Math.round((mappedColumns / totalRequiredColumns) * 100);
  
  summary += `ğŸ¯ ì»¬ëŸ¼ ë§¤í•‘ í’ˆì§ˆ: ${mappingQuality}% (${mappedColumns}/${totalRequiredColumns})\n`;
  
  if (successRate < 50) {
    summary += '\nâš ï¸ ê°œì„  ì œì•ˆ:\n';
    summary += '   â€¢ ì—‘ì…€ ì»¬ëŸ¼ëª…ì„ í‘œì¤€ëª…ìœ¼ë¡œ ë³€ê²½ (Summary, Precondition, Expected Result)\n';
    summary += '   â€¢ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ëª…í™•í•œ í…ìŠ¤íŠ¸ ì‘ì„±\n';
  }
  
  return summary;
}

// ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ê°’ ì¶”ì¶œ
function extractColumnValue(row, possibleColumns) {
  for (let colName of possibleColumns) {
    if (row[colName] !== undefined && row[colName] !== null && row[colName] !== '') {
      return String(row[colName]).trim();
    }
  }
  return '';
}

// í‚¤ì›Œë“œ ë§¤í•‘ ìˆ˜í–‰ (ê°•í™”ëœ í”¼ë“œë°±)
function performKeywordMapping(summary, precondition, expectedResult) {
  let mapping = '';
  let script = '';
  let hasValidMapping = false;
  let successCount = 0;
  
  // Summary ì²˜ë¦¬
  if (summary) {
    const summaryResult = mapKeywordWithFeedback(summary, 'action');
    mapping += summaryResult.feedback;
    script += summaryResult.script;
    if (summaryResult.success) {
      hasValidMapping = true;
      successCount++;
    }
  } else {
    mapping += '[Summary] âŒ ë°ì´í„° ì—†ìŒ\n';
  }
  
  // Precondition ì²˜ë¦¬  
  if (precondition) {
    const preconditionResult = mapKeywordWithFeedback(precondition, 'setup');
    mapping += preconditionResult.feedback;
    script = preconditionResult.script + '\n' + script; // ì•ìª½ì— ì¶”ê°€
    if (preconditionResult.success) {
      hasValidMapping = true;
      successCount++;
    }
  } else {
    mapping += '[Precondition] âŒ ë°ì´í„° ì—†ìŒ\n';
  }
  
  // Expected Result ì²˜ë¦¬
  if (expectedResult) {
    const expectedResultMap = mapKeywordWithFeedback(expectedResult, 'verify');
    mapping += expectedResultMap.feedback;
    script += '\n' + expectedResultMap.script;
    if (expectedResultMap.success) {
      hasValidMapping = true;
      successCount++;
    }
  } else {
    mapping += '[Expected Result] âŒ ë°ì´í„° ì—†ìŒ\n';
  }
  
  // ì „ì²´ ë§¤í•‘ ê²°ê³¼ ìš”ì•½
  if (!hasValidMapping) {
    mapping += '\nğŸ’¡ ê°œì„  ì œì•ˆ:\n';
    mapping += '   â€¢ í‚¤ì›Œë“œ í¬í•¨: í´ë¦­, ì…ë ¥, í™•ì¸, ì´ë™ ë“±\n';
    mapping += '   â€¢ ëª…í™•í•œ ë™ì‘ í‘œí˜„: "ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"\n';
    script = '// âŒ ìë™ ë§¤í•‘ ì‹¤íŒ¨\n// TODO: ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.\n// ì§€ì› í‚¤ì›Œë“œ: í´ë¦­, ë”ë¸”í´ë¦­, ì…ë ¥, í™•ì¸, ì´ë™, ì„ íƒ, ì²´í¬, ëŒ€ê¸°, ìŠ¤í¬ë¡¤';
  }
  
  return { 
    mapping, 
    script, 
    hasValidMapping, 
    successCount 
  };
}

// ê°œë³„ í‚¤ì›Œë“œ ë§¤í•‘ (ê°•í™”ëœ í”¼ë“œë°±)
function mapKeywordWithFeedback(text, type) {
  const textLower = text.toLowerCase();
  let feedback = '';
  let script = '';
  let success = false;
  
  feedback += `[${getTypeLabel(type)}] "${text}"\n`;
  
  // í‚¤ì›Œë“œ ë§¤í•‘ í…Œì´ë¸” (ìš°ì„ ìˆœìœ„ ìˆœ)
  const keywordMappings = [
    // í´ë¦­ ê´€ë ¨ (êµ¬ì²´ì ì¸ ê²ƒë¶€í„°)
    { keywords: ['ë”ë¸”í´ë¦­', 'double'], script: 'WebUI.doubleClick(findTestObject("Object/TargetButton"))', type: 'action', desc: 'ë”ë¸”í´ë¦­' },
    { keywords: ['ìš°í´ë¦­', 'right'], script: 'WebUI.rightClick(findTestObject("Object/TargetButton"))', type: 'action', desc: 'ìš°í´ë¦­' },
    { keywords: ['í´ë¦­', 'click'], script: 'WebUI.click(findTestObject("Object/TargetButton"))', type: 'action', desc: 'í´ë¦­' },
    
    // ì…ë ¥ ê´€ë ¨
    { keywords: ['íŒ¨ìŠ¤ì›Œë“œì…ë ¥', 'ë¹„ë°€ë²ˆí˜¸ì…ë ¥', 'ì•”í˜¸ì…ë ¥'], script: 'WebUI.setEncryptedText(findTestObject("Object/PasswordField"), "TODO_PASSWORD")', type: 'action', desc: 'íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥' },
    { keywords: ['í…ìŠ¤íŠ¸ì…ë ¥', 'ë¬¸ìì…ë ¥'], script: 'WebUI.setText(findTestObject("Object/InputField"), "TODO_TEXT")', type: 'action', desc: 'í…ìŠ¤íŠ¸ ì…ë ¥' },
    { keywords: ['ì…ë ¥', 'input'], script: 'WebUI.setText(findTestObject("Object/InputField"), "TODO_TEXT")', type: 'action', desc: 'ì…ë ¥' },
    
    // ê²€ì¦ ê´€ë ¨
    { keywords: ['í…ìŠ¤íŠ¸í™•ì¸', 'ë¬¸ìí™•ì¸'], script: 'WebUI.verifyElementText(findTestObject("Object/TextElement"), "TODO_EXPECTED_TEXT")', type: 'verify', desc: 'í…ìŠ¤íŠ¸ í™•ì¸' },
    { keywords: ['ì¡´ì¬í™•ì¸', 'ìš”ì†Œì¡´ì¬'], script: 'WebUI.verifyElementPresent(findTestObject("Object/TargetElement"), 10)', type: 'verify', desc: 'ìš”ì†Œ ì¡´ì¬ í™•ì¸' },
    { keywords: ['ë…¸ì¶œ', 'í‘œì‹œ', 'ë³´ì„'], script: 'WebUI.verifyElementVisible(findTestObject("Object/TargetElement"), 10)', type: 'verify', desc: 'ìš”ì†Œ ê°€ì‹œì„± í™•ì¸' },
    { keywords: ['í™•ì¸', 'verify'], script: 'WebUI.verifyElementVisible(findTestObject("Object/TargetElement"), 10)', type: 'verify', desc: 'í™•ì¸' },
    
    // ë„¤ë¹„ê²Œì´ì…˜
    { keywords: ['í˜ì´ì§€ì´ë™', 'urlì´ë™'], script: 'WebUI.navigateToUrl("TODO_TARGET_URL")', type: 'setup', desc: 'í˜ì´ì§€ ì´ë™' },
    { keywords: ['ì´ë™', 'navigate'], script: 'WebUI.navigateToUrl("TODO_TARGET_URL")', type: 'setup', desc: 'ì´ë™' },
    { keywords: ['ìƒˆì°½', 'newwindow'], script: 'WebUI.openBrowser("")', type: 'setup', desc: 'ìƒˆì°½ ì—´ê¸°' },
    
    // ê¸°íƒ€
    { keywords: ['ì„ íƒ', 'select'], script: 'WebUI.selectOptionByLabel(findTestObject("Object/Dropdown"), "TODO_OPTION", false)', type: 'action', desc: 'ì„ íƒ' },
    { keywords: ['ì²´í¬', 'check'], script: 'WebUI.check(findTestObject("Object/Checkbox"))', type: 'action', desc: 'ì²´í¬' },
    { keywords: ['ëŒ€ê¸°', 'wait'], script: 'WebUI.delay(3)', type: 'action', desc: 'ëŒ€ê¸°' },
    { keywords: ['ìŠ¤í¬ë¡¤', 'scroll'], script: 'WebUI.scrollToElement(findTestObject("Object/TargetElement"), 10)', type: 'action', desc: 'ìŠ¤í¬ë¡¤' }
  ];
  
  // í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œë„
  for (let mapping of keywordMappings) {
    if (type === 'any' || mapping.type === type) {
      for (let keyword of mapping.keywords) {
        if (textLower.includes(keyword.toLowerCase())) {
          feedback += `  â†’ âœ… "${keyword}" í‚¤ì›Œë“œ ê°ì§€ â†’ ${mapping.desc}\n`;
          script += mapping.script + '\n';
          success = true;
          return { feedback, script, success };
        }
      }
    }
  }
  
  // ë§¤í•‘ ì‹¤íŒ¨ì‹œ ìƒì„¸ ë¶„ì„
  feedback += '  â†’ âŒ ë§¤í•‘ ì‹¤íŒ¨\n';
  feedback += '  ğŸ” ë¶„ì„:\n';
  
  // ìœ ì‚¬ í‚¤ì›Œë“œ ì œì•ˆ
  const suggestions = findSimilarKeywords(textLower, keywordMappings, type);
  if (suggestions.length > 0) {
    feedback += `  ğŸ’¡ ìœ ì‚¬ í‚¤ì›Œë“œ: ${suggestions.join(', ')}\n`;
  } else {
    feedback += `  ğŸ’¡ ì§€ì› í‚¤ì›Œë“œ (${getTypeLabel(type)}): `;
    const typeKeywords = keywordMappings
      .filter(m => m.type === type)
      .slice(0, 3)
      .map(m => m.keywords[0]);
    feedback += `${typeKeywords.join(', ')}\n`;
  }
  
  script += `// TODO: "${text}" â†’ ìˆ˜ë™ ë§¤í•‘ í•„ìš”\n`;
  
  return { feedback, script, success };
}

// íƒ€ì… ë¼ë²¨ ë°˜í™˜
function getTypeLabel(type) {
  const labels = {
    'action': 'Action',
    'setup': 'Setup', 
    'verify': 'Verify',
    'any': 'Any'
  };
  return labels[type] || type;
}

// ìœ ì‚¬ í‚¤ì›Œë“œ ì°¾ê¸°
function findSimilarKeywords(inputText, mappings, type) {
  const suggestions = [];
  
  for (let mapping of mappings) {
    if (type === 'any' || mapping.type === type) {
      for (let keyword of mapping.keywords) {
        // ë¶€ë¶„ ì¼ì¹˜ë‚˜ ìœ ì‚¬ë„ ì²´í¬
        if (keyword.includes(inputText.substring(0, 2)) || 
            inputText.includes(keyword.substring(0, 2))) {
          suggestions.push(keyword);
          if (suggestions.length >= 3) break;
        }
      }
      if (suggestions.length >= 3) break;
    }
  }
  
  return [...new Set(suggestions)]; // ì¤‘ë³µ ì œê±°
}

// ê°œë³„ í‚¤ì›Œë“œ ë§¤í•‘
function mapKeyword(text, type) {
  const textLower = text.toLowerCase();
  let mapping = '';
  let script = '';
  let success = false;
  
  // í‚¤ì›Œë“œ ë§¤í•‘ í…Œì´ë¸”
  const keywordMappings = {
    // í´ë¦­ ê´€ë ¨
    'ë”ë¸”í´ë¦­': { script: 'WebUI.doubleClick(findTestObject("Object/TargetButton"))', type: 'action' },
    'ìš°í´ë¦­': { script: 'WebUI.rightClick(findTestObject("Object/TargetButton"))', type: 'action' },
    'í´ë¦­': { script: 'WebUI.click(findTestObject("Object/TargetButton"))', type: 'action' },
    
    // ì…ë ¥ ê´€ë ¨
    'íŒ¨ìŠ¤ì›Œë“œì…ë ¥': { script: 'WebUI.setEncryptedText(findTestObject("Object/PasswordField"), "TODO_PASSWORD")', type: 'action' },
    'ë¹„ë°€ë²ˆí˜¸ì…ë ¥': { script: 'WebUI.setEncryptedText(findTestObject("Object/PasswordField"), "TODO_PASSWORD")', type: 'action' },
    'í…ìŠ¤íŠ¸ì…ë ¥': { script: 'WebUI.setText(findTestObject("Object/InputField"), "TODO_TEXT")', type: 'action' },
    'ì…ë ¥': { script: 'WebUI.setText(findTestObject("Object/InputField"), "TODO_TEXT")', type: 'action' },
    
    // ê²€ì¦ ê´€ë ¨
    'í…ìŠ¤íŠ¸í™•ì¸': { script: 'WebUI.verifyElementText(findTestObject("Object/TextElement"), "TODO_EXPECTED_TEXT")', type: 'verify' },
    'ì¡´ì¬í™•ì¸': { script: 'WebUI.verifyElementPresent(findTestObject("Object/TargetElement"), 10)', type: 'verify' },
    'ë…¸ì¶œ': { script: 'WebUI.verifyElementVisible(findTestObject("Object/TargetElement"), 10)', type: 'verify' },
    'í™•ì¸': { script: 'WebUI.verifyElementVisible(findTestObject("Object/TargetElement"), 10)', type: 'verify' },
    
    // ë„¤ë¹„ê²Œì´ì…˜
    'í˜ì´ì§€ì´ë™': { script: 'WebUI.navigateToUrl("TODO_TARGET_URL")', type: 'setup' },
    'ì´ë™': { script: 'WebUI.navigateToUrl("TODO_TARGET_URL")', type: 'setup' },
    'ìƒˆì°½': { script: 'WebUI.openBrowser("")', type: 'setup' },
    
    // ê¸°íƒ€
    'ì„ íƒ': { script: 'WebUI.selectOptionByLabel(findTestObject("Object/Dropdown"), "TODO_OPTION", false)', type: 'action' },
    'ì²´í¬': { script: 'WebUI.check(findTestObject("Object/Checkbox"))', type: 'action' },
    'ëŒ€ê¸°': { script: 'WebUI.delay(3)', type: 'action' },
    'ìŠ¤í¬ë¡¤': { script: 'WebUI.scrollToElement(findTestObject("Object/TargetElement"), 10)', type: 'action' }
  };
  
  // í‚¤ì›Œë“œ ë§¤ì¹­ (ìš°ì„ ìˆœìœ„ ìˆœì„œëŒ€ë¡œ)
  for (let keyword in keywordMappings) {
    if (textLower.includes(keyword)) {
      const mappingData = keywordMappings[keyword];
      if (type === 'any' || mappingData.type === type) {
        mapping += `  â†’ âœ… "${keyword}" í‚¤ì›Œë“œ ê°ì§€\n`;
        script += mappingData.script + '\n';
        success = true;
        break;
      }
    }
  }
  
  // ë§¤í•‘ ì‹¤íŒ¨
  if (!success) {
    mapping += `  â†’ âŒ ë§¤í•‘ ê°€ëŠ¥í•œ í‚¤ì›Œë“œ ì—†ìŒ\n`;
    script += `// TODO: "${text}" ë§¤í•‘ í•„ìš”\n`;
  }
  
  return { mapping, script, success };
}

// ê²°ê³¼ í‘œì‹œ
function displayResults(mappingResults, generatedCode) {
  const mappingDiv = document.getElementById('tcScriptMappingResult');
  const codeDiv = document.getElementById('tcScriptGeneratedCode');
  
  if (mappingDiv) {
    mappingDiv.textContent = mappingResults;
    console.log('âœ… ë§¤í•‘ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  } else {
    console.error('âŒ tcScriptMappingResult div ì—†ìŒ');
  }
  
  if (codeDiv) {
    codeDiv.textContent = generatedCode;
    console.log('âœ… ì½”ë“œ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  } else {
    console.error('âŒ tcScriptGeneratedCode div ì—†ìŒ');
  }
}

function downloadTCOnly() {
  alert('TCë§Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
}

function downloadScriptOnly() {
  alert('Scriptë§Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
}

function downloadMergedFiles() {
  alert('ë³‘í•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
}

function clearTCScriptOutput() {
  console.log('clearTCScriptOutput í•¨ìˆ˜ í˜¸ì¶œë¨');
  document.getElementById('tcScriptMappingResult').textContent = 'ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  TC+Script ìƒì„±ì„ í´ë¦­í•˜ë©´ ë§¤í•‘ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  document.getElementById('tcScriptGeneratedCode').textContent = 'ìƒì„±ëœ Katalon ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  tcScriptData = [];
  tcScriptResults = [];
}

// ë§¤í•‘ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testMapping() {
  console.log('ğŸ§ª ë§¤í•‘ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
  
  // í…ŒìŠ¤íŠ¸ ë°ì´í„°
  const testData = [
    {
      Summary: "ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­",
      Precondition: "ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ì†",
      "Expected Result": "ë©”ì¸ í˜ì´ì§€ ì´ë™"
    },
    {
      Summary: "ì‚¬ìš©ìëª… ì…ë ¥", 
      Precondition: "",
      "Expected Result": "ì‚¬ìš©ìëª… í‘œì‹œ í™•ì¸"
    },
    {
      Summary: "ê²€ìƒ‰ ë²„íŠ¼ ë”ë¸”í´ë¦­",
      Precondition: "ê²€ìƒ‰ í˜ì´ì§€",
      "Expected Result": "ê²€ìƒ‰ ê²°ê³¼ ë…¸ì¶œ"
    }
  ];
  
  let mappingResults = 'ğŸ§ª ë§¤í•‘ í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n\n';
  let generatedCode = 'ğŸ§ª ìƒì„±ëœ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸:\n\n';
  
  testData.forEach((row, idx) => {
    console.log(`í…ŒìŠ¤íŠ¸ ${idx + 1}:`, row);
    
    const summary = row.Summary || '';
    const precondition = row.Precondition || '';
    const expectedResult = row['Expected Result'] || '';
    
    // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤í•‘ í…ŒìŠ¤íŠ¸
    const result = simpleKeywordTest(summary, precondition, expectedResult);
    
    mappingResults += `ğŸ“‹ [${idx + 1}] ${summary}\n`;
    mappingResults += `${result.mapping}\n\n`;
    
    generatedCode += `// ========== í…ŒìŠ¤íŠ¸ ${idx + 1} ==========\n`;
    generatedCode += `${result.script}\n\n`;
  });
  
  // ê²°ê³¼ í‘œì‹œ
  const mappingDiv = document.getElementById('tcScriptMappingResult');
  const codeDiv = document.getElementById('tcScriptGeneratedCode');
  
  if (mappingDiv) {
    mappingDiv.textContent = mappingResults;
    console.log('âœ… ë§¤í•‘ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  }
  
  if (codeDiv) {
    codeDiv.textContent = generatedCode;
    console.log('âœ… ì½”ë“œ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  }
}

// ê°„ë‹¨í•œ í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
function simpleKeywordTest(summary, precondition, expectedResult) {
  const summaryLower = summary.toLowerCase();
  let mapping = '';
  let script = '';
  
  // Summary í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
  mapping += `[Summary] ${summary}\n`;
  
  if (summaryLower.includes('ë”ë¸”í´ë¦­')) {
    mapping += '  â†’ âœ… "ë”ë¸”í´ë¦­" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.doubleClick(findTestObject("Object/TargetButton"))\n';
  } else if (summaryLower.includes('í´ë¦­')) {
    mapping += '  â†’ âœ… "í´ë¦­" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.click(findTestObject("Object/TargetButton"))\n';
  } else if (summaryLower.includes('ì…ë ¥')) {
    mapping += '  â†’ âœ… "ì…ë ¥" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.setText(findTestObject("Object/InputField"), "testValue")\n';
  } else {
    mapping += '  â†’ âŒ ë§¤í•‘ ê°€ëŠ¥í•œ í‚¤ì›Œë“œ ì—†ìŒ\n';
    script += '// âŒ ë§¤í•‘ ì‹¤íŒ¨: ì§€ì›ë˜ì§€ ì•ŠëŠ” ì•¡ì…˜\n';
  }
  
  // Expected Result í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
  if (expectedResult) {
    mapping += `[Expected Result] ${expectedResult}\n`;
    const expectedLower = expectedResult.toLowerCase();
    
    if (expectedLower.includes('í™•ì¸') || expectedLower.includes('ë…¸ì¶œ')) {
      mapping += '  â†’ âœ… "í™•ì¸/ë…¸ì¶œ" í‚¤ì›Œë“œ ê°ì§€\n';
      script += 'WebUI.verifyElementVisible(findTestObject("Object/ResultElement"), 10)\n';
    } else if (expectedLower.includes('ì´ë™')) {
      mapping += '  â†’ âœ… "ì´ë™" í‚¤ì›Œë“œ ê°ì§€\n';
      script += 'WebUI.verifyMatch(WebUI.getUrl(), ".*expectedPage.*", true)\n';
    }
  }
  
  return { mapping, script };
}

// ======= ê¸°ì¡´ ì½”ë“œë“¤ =======
// ê²°ê³¼ê°’ Report ë¶„ì„ê¸°
document.getElementById('reportFileInput')?.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const previewFrame = document.getElementById('reportPreview');
  const resultDiv = document.getElementById('reportResult');

  const reader = new FileReader();
  reader.onload = function(e) {
    const html = e.target.result;
    previewFrame.srcdoc = html;

    previewFrame.onload = function() {
      try {
        const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        const x = path => doc.evaluate(path, doc, null, XPathResult.STRING_TYPE, null).stringValue.trim() || "-";

        const name = x("/html/body/div[2]/div[2]/div[1]/div[1]");
        const StartTime = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[1]/div/div/div[1]/div[2]");
        const EndTime = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[1]/div/div/div[2]/div[2]");
        const Duration = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[1]/div/div/div[3]/div[2]");
        const total = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[1]/div[1]");
        const pass = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[3]/div[1]");
        const fail = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[4]/div[1]");
        const error = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[5]/div[1]");
        const incomplete = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[6]/div[1]");
        const skipped = x("/html/body/div[2]/div[2]/div[3]/div/div[2]/div/div[2]/div/div/div[7]/div[1]");

        const totalNum = parseInt(total) || 0;
        const passNum = parseInt(pass) || 0;
        const failNum = parseInt(fail) || 0;
        const errorNum = parseInt(error) || 0;
        const incompleteNum = parseInt(incomplete) || 0;
        const skippedNum = parseInt(skipped) || 0;

        function percent(n) {
          if (!totalNum) return '0%';
          return ((n / totalNum) * 100).toFixed(1) + '%';
        }

        resultDiv.innerHTML = `
          <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½</h2>
          <table style="width:100%; border-collapse: collapse;">
            <tr><th align="left">Name : </th><td>${name}</td></tr>
            <tr><th align="left">Start Time : </th><td>${StartTime}</td></tr>
            <tr><th align="left">End Time : </th><td>${EndTime}</td></tr>
            <tr><th align="left">Duration : </th><td>${Duration}</td></tr>
            <tr><th align="left">ì „ì²´ : </th><td>${totalNum}ê°œ (100%)</td></tr>
            <tr><th align="left">PASS : </th><td>${passNum}ê°œ (${percent(passNum)})</td></tr>
            <tr><th align="left">FAIL : </th><td>${failNum}ê°œ (${percent(failNum)})</td></tr>
            <tr><th align="left">ERROR : </th><td>${errorNum}ê°œ (${percent(errorNum)})</td></tr>
            <tr><th align="left">INCOMPLETE : </th><td>${incompleteNum}ê°œ (${percent(incompleteNum)})</td></tr>
            <tr><th align="left">SKIPPED : </th><td>${skippedNum}ê°œ (${percent(skippedNum)})</td></tr>
          </table>
          <br><canvas id="reportChart"></canvas>`;

        const values = [pass, fail, error, incomplete, skipped].map(v => parseInt(v) || 0);
        const ctx = document.getElementById('reportChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ["Pass", "Fail", "Error", "Incomplete", "Skipped"],
            datasets: [{
              data: values,
              backgroundColor: ["#4caf50", "#f44336", "#ff9800", "#9c27b0", "#03a9f4"]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„í¬' }
            }
          }
        });

// TC+Script íƒ­ ì „ìš© ë³€ìˆ˜ ë° í•¨ìˆ˜
let tcScriptData = [];
let tcScriptResults = [];

// ì „ì—­ í•¨ìˆ˜ë¡œ ë‹¤ì‹œ ì •ì˜ (í…ŒìŠ¤íŠ¸ìš©)
window.generateTCScript = function() {
  console.log('âœ… generateTCScript í•¨ìˆ˜ í˜¸ì¶œ ì„±ê³µ!');
  alert('âœ… í•¨ìˆ˜ í˜¸ì¶œ ì„±ê³µ! ì´ì œ ë§¤í•‘ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
  
  // í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ë§¤í•‘ í™•ì¸
  testMapping();
};

window.downloadTCOnly = function() {
  alert('TCë§Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
};

window.downloadScriptOnly = function() {
  alert('Scriptë§Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
};

window.downloadMergedFiles = function() {
  alert('ë³‘í•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œë¨');
};

window.clearTCScriptOutput = function() {
  console.log('clearTCScriptOutput í•¨ìˆ˜ í˜¸ì¶œë¨');
  document.getElementById('tcScriptMappingResult').textContent = 'ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  TC+Script ìƒì„±ì„ í´ë¦­í•˜ë©´ ë§¤í•‘ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  document.getElementById('tcScriptGeneratedCode').textContent = 'ìƒì„±ëœ Katalon ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  tcScriptData = [];
  tcScriptResults = [];
};

// ë§¤í•‘ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testMapping() {
  console.log('ğŸ§ª ë§¤í•‘ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
  
  // í…ŒìŠ¤íŠ¸ ë°ì´í„°
  const testData = [
    {
      Summary: "ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­",
      Precondition: "ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ì†",
      "Expected Result": "ë©”ì¸ í˜ì´ì§€ ì´ë™"
    },
    {
      Summary: "ì‚¬ìš©ìëª… ì…ë ¥", 
      Precondition: "",
      "Expected Result": "ì‚¬ìš©ìëª… í‘œì‹œ í™•ì¸"
    },
    {
      Summary: "ê²€ìƒ‰ ë²„íŠ¼ ë”ë¸”í´ë¦­",
      Precondition: "ê²€ìƒ‰ í˜ì´ì§€",
      "Expected Result": "ê²€ìƒ‰ ê²°ê³¼ ë…¸ì¶œ"
    }
  ];
  
  let mappingResults = 'ğŸ§ª ë§¤í•‘ í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n\n';
  let generatedCode = 'ğŸ§ª ìƒì„±ëœ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸:\n\n';
  
  testData.forEach((row, idx) => {
    console.log(`í…ŒìŠ¤íŠ¸ ${idx + 1}:`, row);
    
    const summary = row.Summary || '';
    const precondition = row.Precondition || '';
    const expectedResult = row['Expected Result'] || '';
    
    console.log(`Summary: "${summary}"`);
    console.log(`Precondition: "${precondition}"`);
    console.log(`Expected: "${expectedResult}"`);
    
    // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤í•‘ í…ŒìŠ¤íŠ¸
    const result = simpleKeywordTest(summary, precondition, expectedResult);
    
    mappingResults += `ğŸ“‹ [${idx + 1}] ${summary}\n`;
    mappingResults += `${result.mapping}\n\n`;
    
    generatedCode += `// ========== í…ŒìŠ¤íŠ¸ ${idx + 1} ==========\n`;
    generatedCode += `${result.script}\n\n`;
  });
  
  // ê²°ê³¼ í‘œì‹œ
  const mappingDiv = document.getElementById('tcScriptMappingResult');
  const codeDiv = document.getElementById('tcScriptGeneratedCode');
  
  if (mappingDiv) {
    mappingDiv.textContent = mappingResults;
    console.log('âœ… ë§¤í•‘ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  } else {
    console.error('âŒ tcScriptMappingResult div ì—†ìŒ');
  }
  
  if (codeDiv) {
    codeDiv.textContent = generatedCode;
    console.log('âœ… ì½”ë“œ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
  } else {
    console.error('âŒ tcScriptGeneratedCode div ì—†ìŒ');
  }
}

// ê°„ë‹¨í•œ í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
function simpleKeywordTest(summary, precondition, expectedResult) {
  const summaryLower = summary.toLowerCase();
  let mapping = '';
  let script = '';
  
  // Summary í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
  mapping += `[Summary] ${summary}\n`;
  
  if (summaryLower.includes('ë”ë¸”í´ë¦­')) {
    mapping += '  â†’ âœ… "ë”ë¸”í´ë¦­" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.doubleClick(findTestObject("Object/TargetButton"))\n';
  } else if (summaryLower.includes('í´ë¦­')) {
    mapping += '  â†’ âœ… "í´ë¦­" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.click(findTestObject("Object/TargetButton"))\n';
  } else if (summaryLower.includes('ì…ë ¥')) {
    mapping += '  â†’ âœ… "ì…ë ¥" í‚¤ì›Œë“œ ê°ì§€\n';
    script += 'WebUI.setText(findTestObject("Object/InputField"), "testValue")\n';
  } else {
    mapping += '  â†’ âŒ ë§¤í•‘ ê°€ëŠ¥í•œ í‚¤ì›Œë“œ ì—†ìŒ\n';
    script += '// âŒ ë§¤í•‘ ì‹¤íŒ¨: ì§€ì›ë˜ì§€ ì•ŠëŠ” ì•¡ì…˜\n';
  }
  
  // Expected Result í‚¤ì›Œë“œ í…ŒìŠ¤íŠ¸
  if (expectedResult) {
    mapping += `[Expected Result] ${expectedResult}\n`;
    const expectedLower = expectedResult.toLowerCase();
    
    if (expectedLower.includes('í™•ì¸') || expectedLower.includes('ë…¸ì¶œ')) {
      mapping += '  â†’ âœ… "í™•ì¸/ë…¸ì¶œ" í‚¤ì›Œë“œ ê°ì§€\n';
      script += 'WebUI.verifyElementVisible(findTestObject("Object/ResultElement"), 10)\n';
    } else if (expectedLower.includes('ì´ë™')) {
      mapping += '  â†’ âœ… "ì´ë™" í‚¤ì›Œë“œ ê°ì§€\n';
      script += 'WebUI.verifyMatch(WebUI.getUrl(), ".*expectedPage.*", true)\n';
    }
  }
  
  return { mapping, script };
}

// TC+Script íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
  // TC+Script ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
  const generateBtn = document.getElementById('generateTCScriptBtn');
  const downloadTCBtn = document.getElementById('downloadTCOnlyBtn');
  const downloadScriptBtn = document.getElementById('downloadScriptOnlyBtn');
  const downloadMergedBtn = document.getElementById('downloadMergedBtn');
  const clearBtn = document.getElementById('clearTCScriptBtn');
  
  if (generateBtn) {
    generateBtn.addEventListener('click', generateTCScript);
  }
  
  if (downloadTCBtn) {
    downloadTCBtn.addEventListener('click', downloadTCOnly);
  }
  
  if (downloadScriptBtn) {
    downloadScriptBtn.addEventListener('click', downloadScriptOnly);
  }
  
  if (downloadMergedBtn) {
    downloadMergedBtn.addEventListener('click', downloadMergedFiles);
  }
  
  if (clearBtn) {
    clearBtn.addEventListener('click', clearTCScriptOutput);
  }
  
  console.log('TC+Script íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
});

// ê°œì„ ëœ ìš°ì„ ìˆœìœ„ ê¸°ë°˜ Katalon ë§¤í•‘
const priorityMappings = [
  // êµ¬ì²´ì ì¸ í‚¤ì›Œë“œë¶€í„° ë§¤ì¹­ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
  { keywords: ["ë”ë¸”í´ë¦­", "double", "ë‘ë²ˆí´ë¦­"], action: "doubleClick", type: "action" },
  { keywords: ["ìš°í´ë¦­", "right", "ë§ˆìš°ìŠ¤ìš°í´ë¦­"], action: "rightClick", type: "action" },
  { keywords: ["í…ìŠ¤íŠ¸í™•ì¸", "ë¬¸ìí™•ì¸", "ë¬¸ìì—´í™•ì¸"], action: "verifyElementText", type: "verify" },
  { keywords: ["ì†ì„±í™•ì¸", "ì–´íŠ¸ë¦¬ë·°íŠ¸í™•ì¸"], action: "verifyElementAttributeValue", type: "verify" },
  { keywords: ["ì¡´ì¬í™•ì¸", "ìš”ì†Œì¡´ì¬"], action: "verifyElementPresent", type: "verify" },
  { keywords: ["íŒ¨ìŠ¤ì›Œë“œì…ë ¥", "ë¹„ë°€ë²ˆí˜¸ì…ë ¥", "ì•”í˜¸ì…ë ¥"], action: "setEncryptedText", type: "input" },
  { keywords: ["í…ìŠ¤íŠ¸ì…ë ¥", "ë¬¸ìì…ë ¥"], action: "setText", type: "input" },
  { keywords: ["í˜ì´ì§€ì´ë™", "urlì´ë™"], action: "navigateToUrl", type: "navigation" },
  { keywords: ["íŒŒì¼ì—…ë¡œë“œ", "íŒŒì¼ì„ íƒ", "ì—…ë¡œë“œ"], action: "uploadFile", type: "action" },
  { keywords: ["ìƒˆì°½ì—´ê¸°", "ìƒˆì°½"], action: "openBrowser", type: "navigation" },
  { keywords: ["ì²´í¬í•´ì œ", "ì–¸ì²´í¬"], action: "uncheck", type: "action" },
  { keywords: ["ìš”ì†ŒëŒ€ê¸°", "ì—˜ë¦¬ë¨¼íŠ¸ëŒ€ê¸°"], action: "waitForElementPresent", type: "wait" },
  { keywords: ["ì•Œë¦¼í™•ì¸", "ì–¼ëŸ¿í™•ì¸"], action: "acceptAlert", type: "action" },
  { keywords: ["ì•Œë¦¼ì·¨ì†Œ", "ì–¼ëŸ¿ì·¨ì†Œ"], action: "dismissAlert", type: "action" },
  
  // ì¼ë°˜ì ì¸ í‚¤ì›Œë“œ (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)
  { keywords: ["í´ë¦­", "click", "ëˆ„ë¥´ê¸°"], action: "click", type: "action" },
  { keywords: ["ì…ë ¥", "íƒ€ì´í•‘"], action: "setText", type: "input" },
  { keywords: ["í™•ì¸", "ê²€ì¦"], action: "verifyElementPresent", type: "verify" },
  { keywords: ["ë…¸ì¶œ", "í‘œì‹œ", "ë³´ì„"], action: "verifyElementVisible", type: "verify" },
  { keywords: ["ì´ë™", "ê°€ê¸°"], action: "navigateToUrl", type: "navigation" },
  { keywords: ["ì„ íƒ", "ì…€ë ‰íŠ¸"], action: "selectOptionByLabel", type: "action" },
  { keywords: ["ì²´í¬", "ì„ íƒí•˜ê¸°"], action: "check", type: "action" },
  { keywords: ["ëŒ€ê¸°", "ì ì‹œ"], action: "delay", type: "wait" },
  { keywords: ["ìŠ¤í¬ë¡¤", "ìŠ¤í¬ë¡¤ì´ë™"], action: "scrollToElement", type: "action" },
  { keywords: ["ë’¤ë¡œê°€ê¸°", "back"], action: "back", type: "navigation" },
  { keywords: ["ì•ìœ¼ë¡œê°€ê¸°", "forward"], action: "forward", type: "navigation" },
  { keywords: ["ìƒˆë¡œê³ ì¹¨", "refresh", "ë¦¬í”„ë ˆì‹œ"], action: "refresh", type: "navigation" }
];

// ìŠ¤ë§ˆíŠ¸ í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸ ë§¤í•‘
const objectMappings = {
  // ë¡œê·¸ì¸ ê´€ë ¨
  "ë¡œê·¸ì¸": "Object/Login/LoginButton",
  "ë¡œê·¸ì¸ë²„íŠ¼": "Object/Login/LoginButton", 
  "ì‚¬ìš©ìëª…": "Object/Login/UsernameField",
  "ì•„ì´ë””": "Object/Login/UsernameField",
  "userid": "Object/Login/UsernameField",
  "ë¹„ë°€ë²ˆí˜¸": "Object/Login/PasswordField",
  "íŒ¨ìŠ¤ì›Œë“œ": "Object/Login/PasswordField",
  "password": "Object/Login/PasswordField",
  
  // ê²€ìƒ‰ ê´€ë ¨
  "ê²€ìƒ‰": "Object/Search/SearchButton",
  "ê²€ìƒ‰ë²„íŠ¼": "Object/Search/SearchButton",
  "ê²€ìƒ‰ì°½": "Object/Search/SearchInput",
  
  // ë©”ë‰´ ê´€ë ¨
  "ë©”ë‰´": "Object/Menu/MainMenu",
  "í™ˆ": "Object/Menu/HomeButton",
  "ì„¤ì •": "Object/Menu/SettingsButton",
  
  // ë²„íŠ¼ ê´€ë ¨
  "í™•ì¸ë²„íŠ¼": "Object/Common/ConfirmButton",
  "ì·¨ì†Œë²„íŠ¼": "Object/Common/CancelButton",
  "ì €ì¥": "Object/Common/SaveButton",
  "ì‚­ì œ": "Object/Common/DeleteButton",
  "ë“±ë¡": "Object/Common/RegisterButton",
  "ìˆ˜ì •": "Object/Common/EditButton",
  
  // í¼ ê´€ë ¨
  "ì´ë¦„": "Object/Form/NameField",
  "ì´ë©”ì¼": "Object/Form/EmailField",
  "ì „í™”ë²ˆí˜¸": "Object/Form/PhoneField",
  "ì£¼ì†Œ": "Object/Form/AddressField",
  
  // ê¸°íƒ€
  "ë§í¬": "Object/Common/Link",
  "ì´ë¯¸ì§€": "Object/Common/Image",
  "í…ìŠ¤íŠ¸": "Object/Common/Text"
};

// ì•ˆì „í•œ ì»¬ëŸ¼ ê°’ ì¶”ì¶œ (ìˆ˜ì •ë¨)
function safeGetColumnValue(row, columnName) {
  try {
    // ì§ì ‘ ì ‘ê·¼ ì‹œë„
    if (row && row[columnName] !== undefined) {
      return row[columnName] || '';
    }
    
    // ì†Œë¬¸ìë¡œ ì‹œë„
    const lowerColumnName = columnName.toLowerCase();
    if (row && row[lowerColumnName] !== undefined) {
      return row[lowerColumnName] || '';
    }
    
    // ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ëœ ë²„ì „ ì‹œë„
    const normalizedColumn = columnName.replace(/\s+/g, '').toLowerCase();
    for (let key in row) {
      if (key.replace(/\s+/g, '').toLowerCase() === normalizedColumn) {
        return row[key] || '';
      }
    }
    
    console.warn(`Column ${columnName} not found in row:`, Object.keys(row));
    return '';
  } catch (e) {
    console.error(`Error accessing column ${columnName}:`, e);
    return '';
  }
}

// ìŠ¤ë§ˆíŠ¸ í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸ ì¶”ì¶œ
function extractTargetObject(text) {
  if (!text) return "Object/TODO_DefineObject";
  
  const textLower = text.toLowerCase();
  
  // ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” í‚¤ì›Œë“œ ì°¾ê¸°
  for (let key in objectMappings) {
    if (textLower.includes(key.toLowerCase())) {
      return objectMappings[key];
    }
  }
  
  // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ TODO ì˜¤ë¸Œì íŠ¸ ë°˜í™˜
  return "Object/TODO_DefineObject";
}

// TC+Script ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ë””ë²„ê¹… ê°•í™”)
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('tcScriptExcelFile');
  
  if (fileInput) {
    console.log('âœ… tcScriptExcelFile input ìš”ì†Œ ì°¾ìŒ');
    
    fileInput.addEventListener('change', function(e) {
      console.log('ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°œìƒ!');
      const file = e.target.files[0];
      
      if (!file) {
        console.log('âŒ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
        return;
      }

      console.log('ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', {
        name: file.name,
        size: file.size,
        type: file.type
      });

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          console.log('ğŸ“Š íŒŒì¼ ì½ê¸° ì™„ë£Œ, íŒŒì‹± ì‹œì‘...');
          
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          console.log('ğŸ“‹ ì›Œí¬ë¶ ì •ë³´:', {
            sheetNames: workbook.SheetNames,
            sheetCount: workbook.SheetNames.length
          });
          
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          window.tcScriptData = json;
          tcScriptData = json;
          
          console.log('âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ:', {
            rowCount: json.length,
            firstRow: json[0],
            columns: Object.keys(json[0] || {}),
            globalVariable: !!window.tcScriptData
          });
          
          // ì—…ë¡œë“œ ì™„ë£Œ í‘œì‹œ
          const mappingDiv = document.getElementById('tcScriptMappingResult');
          if (mappingDiv) {
            let previewText = `âœ… ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!\n\n`;
            previewText += `ğŸ“Š ì´ ${json.length}ê°œ í–‰ ê°ì§€\n\n`;
            
            if (json.length > 0) {
              previewText += `ğŸ“‹ ê°ì§€ëœ ì»¬ëŸ¼ëª…:\n`;
              Object.keys(json[0]).forEach(col => {
                previewText += `  â€¢ ${col}\n`;
              });
              
              previewText += `\nğŸ“ ì²« ë²ˆì§¸ í–‰ ë¯¸ë¦¬ë³´ê¸°:\n`;
              const firstRow = json[0];
              Object.keys(firstRow).forEach(key => {
                const value = String(firstRow[key]).substring(0, 50);
                previewText += `  ${key}: ${value}${String(firstRow[key]).length > 50 ? '...' : ''}\n`;
              });
            }
            
            previewText += `\nğŸ”§ 'TC+Script ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë§¤í•‘ì„ ì‹œì‘í•˜ì„¸ìš”.`;
            mappingDiv.textContent = previewText;
            
            console.log('âœ… ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì™„ë£Œ');
          } else {
            console.error('âŒ tcScriptMappingResult divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          }
          
        } catch (error) {
          console.error('âŒ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
          alert(`âŒ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      };
      
      reader.onerror = function(error) {
        console.error('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
        alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      };
      
      reader.readAsArrayBuffer(file);
    });
    
    console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
  } else {
    console.error('âŒ tcScriptExcelFile input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
  }
});

// ê°œì„ ëœ í‚¤ì›Œë“œ ë§¤í•‘ í•¨ìˆ˜
function mapToKatalonScript(summary, precondition, expectedResult) {
  try {
    const summaryText = safeGetColumnValue({Summary: summary}, 'Summary');
    const preconditionText = safeGetColumnValue({Precondition: precondition}, 'Precondition');
    const expectedText = safeGetColumnValue({'Expected Result': expectedResult}, 'Expected Result');
    
    let scripts = [];
    let mappingInfo = [];
    let hasValidMapping = false;
    
    // ì»¨í…ìŠ¤íŠ¸ë³„ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    const contextualScript = generateContextualScript(preconditionText, summaryText, expectedText);
    
    if (contextualScript.scripts.length > 0) {
      scripts = contextualScript.scripts;
      mappingInfo = contextualScript.mappingInfo;
      hasValidMapping = contextualScript.hasValidMapping;
    } else {
      // í´ë°±: ê¸°ì¡´ ê°œë³„ ë§¤í•‘
      mappingInfo.push("âš ï¸ ì»¨í…ìŠ¤íŠ¸ ë§¤í•‘ ì‹¤íŒ¨, ê°œë³„ ë§¤í•‘ ì‹œë„");
      
      // ê°œë³„ í•„ë“œ ë§¤í•‘
      [
        { field: 'Precondition', text: preconditionText, label: 'Precondition' },
        { field: 'Summary', text: summaryText, label: 'Main Action' }, 
        { field: 'Expected Result', text: expectedText, label: 'Verification' }
      ].forEach(({field, text, label}) => {
        if (text && text.trim()) {
          const result = mapSingleField(text, label);
          if (result.script) {
            scripts.push(`// ${label}: ${text}`);
            scripts.push(result.script);
            mappingInfo.push(`[${field}] ${text}`);
            mappingInfo.push(`  â†’ ${result.mappingInfo}`);
            if (result.success) hasValidMapping = true;
          }
        }
      });
    }
    
    // ë§¤í•‘ ì‹¤íŒ¨ì‹œ ì•ˆë‚´
    if (!hasValidMapping) {
      scripts = [`// âŒ ìë™ ë§¤í•‘ ì‹¤íŒ¨: ì§€ì›ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 
                `// ğŸ’¡ ì§€ì› í‚¤ì›Œë“œ ì˜ˆì‹œ: ${priorityMappings.slice(0,5).map(m => m.keywords[0]).join(', ')}...`,
                `// ğŸ“ TODO: ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.`];
      mappingInfo.push(`âŒ ë§¤í•‘ ì‹¤íŒ¨ - ì§€ì›ë˜ëŠ” í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.`);
      mappingInfo.push(`ğŸ’¡ ì§€ì› í‚¤ì›Œë“œ: ${priorityMappings.slice(0,8).map(m => m.keywords[0]).join(', ')}...`);
    }
    
    return {
      script: scripts.join('\n'),
      mappingInfo: mappingInfo.join('\n'),
      hasValidMapping
    };
    
  } catch (error) {
    console.error('ë§¤í•‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return {
      script: `// âŒ ë§¤í•‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`,
      mappingInfo: `âŒ ì˜¤ë¥˜: ${error.message}`,
      hasValidMapping: false
    };
  }
}

// ì»¨í…ìŠ¤íŠ¸ ì¸ì‹ ê¸°ë°˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
function generateContextualScript(precondition, summary, expectedResult) {
  let scripts = [];
  let mappingInfo = [];
  let hasValidMapping = false;
  
  try {
    mappingInfo.push("ğŸ”„ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹œì‘...");
    
    // 1. Precondition ì²˜ë¦¬ (ì´ˆê¸° ì„¤ì •)
    if (precondition && precondition.trim()) {
      mappingInfo.push(`[Precondition] ${precondition}`);
      
      // ë¸Œë¼ìš°ì €/í˜ì´ì§€ ê´€ë ¨ precondition
      if (precondition.includes("í˜ì´ì§€") || precondition.includes("ì‚¬ì´íŠ¸") || precondition.includes("í™”ë©´")) {
        scripts.push("// Setup: Browser and Page Navigation");
        scripts.push("WebUI.openBrowser('')");
        scripts.push("WebUI.navigateToUrl('TODO_SET_TARGET_URL')");
        scripts.push("WebUI.maximizeWindow()");
        mappingInfo.push("  â†’ ë¸Œë¼ìš°ì € ì—´ê¸° ë° í˜ì´ì§€ ì´ë™ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±");
        hasValidMapping = true;
      }
      
      // ë¡œê·¸ì¸ ê´€ë ¨ precondition
      if (precondition.includes("ë¡œê·¸ì¸") || precondition.includes("ë¡œê·¸ì¸ëœ")) {
        scripts.push("// Setup: User Login");
        scripts.push("WebUI.setText(findTestObject('Object/Login/UsernameField'), 'testUser')");
        scripts.push("WebUI.setText(findTestObject('Object/Login/PasswordField'), 'testPassword')");
        scripts.push("WebUI.click(findTestObject('Object/Login/LoginButton'))");
        mappingInfo.push("  â†’ ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±");
        hasValidMapping = true;
      }
    }
    
    // 2. Summary ì²˜ë¦¬ (ë©”ì¸ ì•¡ì…˜)
    if (summary && summary.trim()) {
      mappingInfo.push(`[Summary] ${summary}`);
      const mainAction = mapSingleField(summary, "Main Action");
      
      if (mainAction.success) {
        scripts.push("// Main Action");
        scripts.push(mainAction.script);
        mappingInfo.push(`  â†’ ${mainAction.mappingInfo}`);
        hasValidMapping = true;
      } else {
        scripts.push(`// Main Action: ${summary}`);
        scripts.push("// âŒ ë§¤í•‘ ì‹¤íŒ¨: ì§€ì›ë˜ì§€ ì•ŠëŠ” ì•¡ì…˜");
        mappingInfo.push("  â†’ âŒ ë©”ì¸ ì•¡ì…˜ ë§¤í•‘ ì‹¤íŒ¨");
      }
    }
    
    // 3. Expected Result ì²˜ë¦¬ (ê²€ì¦)
    if (expectedResult && expectedResult.trim()) {
      mappingInfo.push(`[Expected Result] ${expectedResult}`);
      
      // ê²€ì¦ íƒ€ì…ë³„ ì²˜ë¦¬
      let verificationScript = generateVerificationScript(expectedResult);
      
      if (verificationScript.success) {
        scripts.push("// Verification");
        scripts.push(verificationScript.script);
        mappingInfo.push(`  â†’ ${verificationScript.mappingInfo}`);
        hasValidMapping = true;
      } else {
        scripts.push(`// Verification: ${expectedResult}`);
        scripts.push("// âŒ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨");
        mappingInfo.push("  â†’ âŒ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ë§¤í•‘ ì‹¤íŒ¨");
      }
    }
    
    // 4. ë§ˆë¬´ë¦¬ (í•„ìš”ì‹œ)
    if (hasValidMapping && scripts.length > 0) {
      scripts.push("// Cleanup");
      scripts.push("WebUI.closeBrowser()");
      mappingInfo.push("ë¸Œë¼ìš°ì € ì¢…ë£Œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€");
    }
    
    return { scripts, mappingInfo, hasValidMapping };
    
  } catch (error) {
    console.error('ì»¨í…ìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
    return { 
      scripts: [`// âŒ ì»¨í…ìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`], 
      mappingInfo: [`âŒ ì˜¤ë¥˜: ${error.message}`], 
      hasValidMapping: false 
    };
  }
}

// ë‹¨ì¼ í•„ë“œ ë§¤í•‘
function mapSingleField(text, fieldType) {
  try {
    const textLower = text.toLowerCase();
    
    // ìš°ì„ ìˆœìœ„ ë§¤í•‘ ìˆ˜í–‰
    for (let mapping of priorityMappings) {
      for (let keyword of mapping.keywords) {
        if (textLower.includes(keyword.toLowerCase())) {
          const targetObject = extractTargetObject(text);
          const script = generateKatalonScript(mapping.action, mapping.type, targetObject, text);
          
          return {
            script: script,
            mappingInfo: `ë§¤í•‘ ì„±ê³µ: "${keyword}" â†’ ${mapping.action}`,
            success: true
          };
        }
      }
    }
    
    return {
      script: null,
      mappingInfo: `ë§¤í•‘ ì‹¤íŒ¨: ì§€ì›ë˜ëŠ” í‚¤ì›Œë“œ ì—†ìŒ`,
      success: false
    };
    
  } catch (error) {
    return {
      script: `// âŒ ë§¤í•‘ ì˜¤ë¥˜: ${error.message}`,
      mappingInfo: `ì˜¤ë¥˜: ${error.message}`,
      success: false
    };
  }
}

// ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
function generateVerificationScript(expectedResult) {
  try {
    const expectedLower = expectedResult.toLowerCase();
    const targetObject = extractTargetObject(expectedResult);
    
    // í…ìŠ¤íŠ¸ ê²€ì¦
    if (expectedLower.includes("í…ìŠ¤íŠ¸") || expectedLower.includes("ë¬¸ì") || expectedLower.includes("í‘œì‹œ")) {
      return {
        script: `WebUI.verifyElementText(findTestObject('${targetObject}'), 'TODO_EXPECTED_TEXT')`,
        mappingInfo: "í…ìŠ¤íŠ¸ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±",
        success: true
      };
    }
    
    // ìš”ì†Œ ì¡´ì¬ ê²€ì¦
    if (expectedLower.includes("ì¡´ì¬") || expectedLower.includes("ë…¸ì¶œ") || expectedLower.includes("ë³´ì„")) {
      return {
        script: `WebUI.verifyElementVisible(findTestObject('${targetObject}'), 10)`,
        mappingInfo: "ìš”ì†Œ ê°€ì‹œì„± ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±", 
        success: true
      };
    }
    
    // í˜ì´ì§€ ì´ë™ ê²€ì¦
    if (expectedLower.includes("í˜ì´ì§€") || expectedLower.includes("ì´ë™") || expectedLower.includes("url")) {
      return {
        script: `WebUI.verifyMatch(WebUI.getUrl(), '.*TODO_EXPECTED_URL.*', true)`,
        mappingInfo: "í˜ì´ì§€ ì´ë™ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±",
        success: true
      };
    }
    
    // ê¸°ë³¸ ì¡´ì¬ ê²€ì¦
    return {
      script: `WebUI.verifyElementPresent(findTestObject('${targetObject}'), 10)`,
      mappingInfo: "ê¸°ë³¸ ìš”ì†Œ ì¡´ì¬ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±",
      success: true
    };
    
  } catch (error) {
    return {
      script: `// âŒ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì˜¤ë¥˜: ${error.message}`,
      mappingInfo: `ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: ${error.message}`,
      success: false
    };
  }
}

// Katalon ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
function generateKatalonScript(action, type, targetObject, originalText) {
  try {
    switch (action) {
      case "click":
      case "doubleClick":
      case "rightClick":
        return `WebUI.${action}(findTestObject('${targetObject}'))`;
        
      case "setText":
        return `WebUI.setText(findTestObject('${targetObject}'), 'TODO_INPUT_TEXT')`;
        
      case "setEncryptedText":
        return `WebUI.setEncryptedText(findTestObject('${targetObject}'), 'TODO_ENCRYPTED_PASSWORD')`;
        
      case "verifyElementText":
        return `WebUI.verifyElementText(findTestObject('${targetObject}'), 'TODO_EXPECTED_TEXT')`;
        
      case "verifyElementPresent":
        return `WebUI.verifyElementPresent(findTestObject('${targetObject}'), 10)`;
        
      case "verifyElementVisible":
        return `WebUI.verifyElementVisible(findTestObject('${targetObject}'), 10)`;
        
      case "verifyElementAttributeValue":
        return `WebUI.verifyElementAttributeValue(findTestObject('${targetObject}'), 'TODO_ATTRIBUTE', 'TODO_VALUE', 10)`;
        
      case "navigateToUrl":
        return `WebUI.navigateToUrl('TODO_TARGET_URL')`;
        
      case "openBrowser":
        return `WebUI.openBrowser('')`;
        
      case "selectOptionByLabel":
        return `WebUI.selectOptionByLabel(findTestObject('${targetObject}'), 'TODO_OPTION_TEXT', false)`;
        
      case "check":
      case "uncheck":
        return `WebUI.${action}(findTestObject('${targetObject}'))`;
        
      case "delay":
        return `WebUI.delay(3)`;
        
      case "waitForElementPresent":
        return `WebUI.waitForElementPresent(findTestObject('${targetObject}'), 10)`;
        
      case "scrollToElement":
        return `WebUI.scrollToElement(findTestObject('${targetObject}'), 10)`;
        
      case "uploadFile":
        return `WebUI.uploadFile(findTestObject('${targetObject}'), 'TODO_FILE_PATH')`;
        
      case "acceptAlert":
      case "dismissAlert":
        return `WebUI.${action}()`;
        
      case "back":
      case "forward":
      case "refresh":
        return `WebUI.${action}()`;
        
      default:
        return `// TODO: Implement ${action} for ${originalText}`;
    }
  } catch (error) {
    return `// âŒ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì˜¤ë¥˜: ${error.message}`;
  }
}

// TC+Script ìƒì„± í•¨ìˆ˜
function generateTCScript() {
  if (!tcScriptData || tcScriptData.length === 0) {
    alert('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }

  tcScriptResults = [];
  let mappingResults = '';
  let generatedCode = '';

  tcScriptData.forEach((row, idx) => {
    const summary = row['Summary'] || '';
    const precondition = row['Precondition'] || '';
    const expectedResult = row['Expected Result'] || '';
    
    const rawName = summary || `TestCase_${idx + 1}`;
    const name = rawName.replace(/[\\/:*?"<>|]/g, '').trim();
    const numberedName = `${String(idx + 1).padStart(3, '0')}_${name}`;
    
    // í‚¤ì›Œë“œ ë§¤í•‘ ì‹¤í–‰
    const mappingResult = mapToKatalonScript(summary, precondition, expectedResult);
    
    // TC íŒŒì¼ ìƒì„± (ê¸°ì¡´ Comment ë°©ì‹)
    const fields = ['Test Level', 'Main Category', 'Sub Category', 'Detail Category', 'Summary', 'Precondition', 'Steps', 'Expected Result'];
    const formatBlock = (label, value) => {
      if (!value) return `${label}   :`;
      return `${label}   : ${value.toString().split(/\n|\\n/).map((l, i) => (i === 0 ? l : ' '.repeat(label.length + 5) + l)).join('\n')}`;
    };

    const comment = `=================== [Testcase] ===================

${fields.map(f => formatBlock(f, row[f] || '')).join('\n')}

===================================================`;

    const tcContent = `<?xml version="1.0" encoding="UTF-8"?>
<TestCaseEntity>
   <description></description>
   <name>${numberedName}</name>
   <tag></tag>
   <comment></comment>
   <recordOption>OTHER</recordOption>
   <testCaseGuid>${generateUUID()}</testCaseGuid>
</TestCaseEntity>`;

    // Script íŒŒì¼ ìƒì„± (ì‹¤ì œ Katalon ì½”ë“œ)
    const scriptContent = `import static com.kms.katalon.core.checkpoint.CheckpointFactory.findCheckpoint
import static com.kms.katalon.core.testcase.TestCaseFactory.findTestCase
import static com.kms.katalon.core.testdata.TestDataFactory.findTestData
import static com.kms.katalon.core.testobject.ObjectRepository.findTestObject
import static com.kms.katalon.core.testobject.ObjectRepository.findWindowsObject
import com.kms.katalon.core.checkpoint.Checkpoint as Checkpoint
import com.kms.katalon.core.cucumber.keyword.CucumberBuiltinKeywords as CucumberKW
import com.kms.katalon.core.mobile.keyword.MobileBuiltInKeywords as Mobile
import com.kms.katalon.core.model.FailureHandling as FailureHandling
import com.kms.katalon.core.testcase.TestCase as TestCase
import com.kms.katalon.core.testdata.TestData as TestData
import com.kms.katalon.core.testng.keyword.TestNGBuiltinKeywords as TestNGKW
import com.kms.katalon.core.testobject.TestObject as TestObject
import com.kms.katalon.core.webservice.keyword.WSBuiltInKeywords as WS
import com.kms.katalon.core.webui.keyword.WebUiBuiltInKeywords as WebUI
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows
import internal.GlobalVariable as GlobalVariable
import org.openqa.selenium.Keys as Keys

// ============== Test Case Comment ==============
WebUI.comment("""
${comment}
""")

// ============== Generated Katalon Script ==============
${mappingResult.script}`;

    // ë³‘í•© íŒŒì¼ ìƒì„± (TC + Script)
    const mergedContent = scriptContent;

    tcScriptResults.push({
      name: numberedName,
      tcContent,
      scriptContent,
      mergedContent,
      mappingInfo: mappingResult.mappingInfo
    });

    // ê²°ê³¼ í…ìŠ¤íŠ¸ ìƒì„±
    mappingResults += `ğŸ“‹ [${idx + 1}] ${numberedName}\n${mappingResult.mappingInfo}\n\n`;
    generatedCode += `// ========== ${numberedName} ==========\n${mappingResult.script}\n\n`;
  });

  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('tcScriptMappingResult').textContent = mappingResults;
  document.getElementById('tcScriptGeneratedCode').textContent = generatedCode;
}

// TCë§Œ ë‹¤ìš´ë¡œë“œ
function downloadTCOnly() {
  if (!tcScriptResults || tcScriptResults.length === 0) {
    alert('ë¨¼ì € TC+Scriptë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }

  const zip = new JSZip();
  tcScriptResults.forEach(file => {
    zip.file(`${file.name}.tc`, file.tcContent);
  });

  zip.generateAsync({ type: 'blob' }).then(content => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'tc_files_only.zip';
    a.click();
  });
}

// Scriptë§Œ ë‹¤ìš´ë¡œë“œ
function downloadScriptOnly() {
  if (!tcScriptResults || tcScriptResults.length === 0) {
    alert('ë¨¼ì € TC+Scriptë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }

  const zip = new JSZip();
  tcScriptResults.forEach(file => {
    zip.file(`${file.name}.groovy`, file.scriptContent);
  });

  zip.generateAsync({ type: 'blob' }).then(content => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'script_files_only.zip';
    a.click();
  });
}

// ë³‘í•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ
function downloadMergedFiles() {
  if (!tcScriptResults || tcScriptResults.length === 0) {
    alert('ë¨¼ì € TC+Scriptë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }

  const zip = new JSZip();
  tcScriptResults.forEach(file => {
    const folder = zip.folder(file.name);
    folder.file(`${file.name}.tc`, file.tcContent);
    folder.file(`${file.name}.groovy`, file.mergedContent);
  });

  zip.generateAsync({ type: 'blob' }).then(content => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'merged_tc_script_files.zip';
    a.click();
  });
}

// ê²°ê³¼ ì´ˆê¸°í™”
function clearTCScriptOutput() {
  document.getElementById('tcScriptMappingResult').textContent = 'ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  TC+Script ìƒì„±ì„ í´ë¦­í•˜ë©´ ë§¤í•‘ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  document.getElementById('tcScriptGeneratedCode').textContent = 'ìƒì„±ëœ Katalon ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
  tcScriptData = [];
  tcScriptResults = [];
}
      } catch (err) {
        resultDiv.innerHTML = `<p style=\"color:red\">âŒ íŒŒì‹± ì‹¤íŒ¨: ${err.message}</p>`;
      }
    };
  };
  reader.readAsText(file);
});

const buttons = document.querySelectorAll('.tab-button');
const contents = document.querySelectorAll('.tab-content');
let activeTab = 'csv';

buttons.forEach(button => {
  button.addEventListener('click', () => {
    buttons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');

    activeTab = button.dataset.tab;
    contents.forEach(c => c.classList.remove('active'));
    document.getElementById(activeTab).classList.add('active');
  });
});

// CSV íŒŒì‹± ë¡œì§ (ìˆ˜ì •ë¨)
let parsed = [];

// í‘œì¤€ í•„ë“œ ì •ì˜
const standardFields = [
  'Test Level', 'Main Category', 'Sub Category', 'Detail Category',
  'Summary', 'Precondition', 'Steps', 'Expected Result'
];

document.getElementById('csvFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const errorDiv = document.getElementById('error');
  errorDiv.textContent = '';

  const reader = new FileReader();
  reader.onload = function(event) {
    const csv = event.target.result;
    const matches = [...csv.matchAll(/comment\(""[\r\n]+([\s\S]*?)[\r\n]+""\)/g)];
    parsed = [];

    for (let i = 0; i < matches.length; i++) {
      const lines = matches[i][1].split(/\r?\n/);
      const obj = { Index: i + 1 };
      let currentKey = null;
      let currentValue = [];

      const pushCurrent = () => {
        if (currentKey) {
          obj[currentKey] = currentValue.join('<br>');
          currentKey = null;
          currentValue = [];
        }
      };

      for (const rawLine of lines) {
        const line = rawLine.trim();
        if (line.startsWith('=') || line === '') continue;

        const parts = line.split(':');
        if (parts.length >= 2) {
          pushCurrent();
          currentKey = parts[0].trim();
          currentValue.push(parts.slice(1).join(':').trim());
        } else if (currentKey) {
          currentValue.push(line);
        }
      }
      pushCurrent();

      // í‘œì¤€ í•„ë“œë§Œ ì¶”ì¶œí•˜ê³  ëˆ„ë½ëœ í•„ë“œëŠ” ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ì›€
      const standardObj = { Index: i + 1 };
      standardFields.forEach(field => {
        standardObj[field] = obj[field] || '';
      });
      
      parsed.push(standardObj);
    }

    if (parsed.length === 0) {
      errorDiv.textContent = 'âš ï¸ ìœ ìš©í•œ comment(""" ... """) ë©”íƒ€ë°ì´í„° ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    // ê³ ì •ëœ ì»¬ëŸ¼ ìˆœì„œ ì‚¬ìš©
    const fixedColumns = ['Index', ...standardFields];
    const data = parsed.map(row => fixedColumns.map(k => row[k] || ''));

    const table = $('#resultTable');
    table.show();
    table.DataTable({
      data: data,
      columns: fixedColumns.map(h => ({ title: h })),
      destroy: true,
      scrollX: true,
      pageLength: 10
    });
  };
  reader.readAsText(file, 'UTF-8');
});

document.getElementById('downloadBtn').addEventListener('click', function() {
  if (!parsed || parsed.length === 0) {
    alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const converted = parsed.map(row => {
    const newRow = {};
    for (const key in row) {
      const raw = row[key];
      newRow[key] = typeof raw === 'string' ? raw.replace(/<br\s*\/?>/g, '\n') : raw;
    }
    return newRow;
  });

  const worksheet = XLSX.utils.json_to_sheet(converted);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Metadata");

  const wbout = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
  const blob = new Blob([wbout], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "testcase_metadata.xlsx";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

document.getElementById('exampleDownloadBtn').addEventListener('click', function() {
  // ìˆ˜ì •ëœ í—¤ë” (ê³ ì •ëœ 9ê°œ ì»¬ëŸ¼)
  const headers = [
    "Index",
    "Test Level",
    "Main Category",
    "Sub Category",
    "Detail Category",
    "Summary",
    "Precondition",
    "Steps",
    "Expected Result"
  ];

  // ì˜ˆì‹œ ë°ì´í„° (ë¹„ì›Œë‘ )
  const data = [headers];

  // ì‹œíŠ¸ ë° ì›Œí¬ë¶ ìƒì„±
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Testcase");

  // íŒŒì¼ë¡œ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ
  const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
  const blob = new Blob([wbout], { type: "application/octet-stream" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "testcase_ì˜ˆì‹œíŒŒì¼.xlsx";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// Groovy íƒ­ ê¸°ëŠ¥ ì‚½ì…
let testCases = [];

function generateUUID() {
  return URL.createObjectURL(new Blob()).split('/').pop();
}

function sanitizeFileName(name) {
  return name.replace(/[\\/:*?"<>|]/g, '').trim();
}

document.getElementById('excelFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  testCases = [];
  const container = document.getElementById('preview');
  container.innerHTML = '';

  const reader = new FileReader();
  reader.onload = function (event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    window.tcScriptData = json;
    tcScriptData = json;

    json.forEach((row, idx) => {
      const rawName = row['Summary'] || row['Name'] || `TestCase_${idx + 1}`;
      const name = sanitizeFileName(rawName);
      const numberedName = `${String(idx + 1).padStart(3, '0')}_${name}`;
      const guid = generateUUID();

      const fields = ['Test Level', 'Main Category', 'Sub Category', 'Detail Category', 'Summary', 'Precondition', 'Steps', 'Expected Result'];
      const formatBlock = (label, value) => {
        if (!value) return `${label}   :`;
        return `${label}   : ${value.split(/\n|\\n/).map((l, i) => (i === 0 ? l : ' '.repeat(label.length + 5) + l)).join('\n')}`;
      };

      const comment = `=================== [Testcase] ===================\n\n` +
        fields.map(f => formatBlock(f, row[f])).join('\n') +
        `\n\n===================================================`;

      const groovy = `import static com.kms.katalon.core.checkpoint.CheckpointFactory.findCheckpoint\n` +
        `import static com.kms.katalon.core.testcase.TestCaseFactory.findTestCase\n` +
        `import static com.kms.katalon.core.testdata.TestDataFactory.findTestData\n` +
        `import static com.kms.katalon.core.testobject.ObjectRepository.findTestObject\n` +
        `import static com.kms.katalon.core.testobject.ObjectRepository.findWindowsObject\n` +
        `import com.kms.katalon.core.checkpoint.Checkpoint as Checkpoint\n` +
        `import com.kms.katalon.core.cucumber.keyword.CucumberBuiltinKeywords as CucumberKW\n` +
        `import com.kms.katalon.core.mobile.keyword.MobileBuiltInKeywords as Mobile\n` +
        `import com.kms.katalon.core.model.FailureHandling as FailureHandling\n` +
        `import com.kms.katalon.core.testcase.TestCase as TestCase\n` +
        `import com.kms.katalon.core.testdata.TestData as TestData\n` +
        `import com.kms.katalon.core.testng.keyword.TestNGBuiltinKeywords as TestNGKW\n` +
        `import com.kms.katalon.core.testobject.TestObject as TestObject\n` +
        `import com.kms.katalon.core.webservice.keyword.WSBuiltInKeywords as WS\n` +
        `import com.kms.katalon.core.webui.keyword.WebUiBuiltInKeywords as WebUI\n` +
        `import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows\n` +
        `import internal.GlobalVariable as GlobalVariable\n` +
        `import org.openqa.selenium.Keys as Keys\n\n` +
        `WebUI.comment(\""\"\n${comment}\n\""\")`;

      const tc = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n` +
        `<TestCaseEntity>\n` +
        `   <description></description>\n` +
        `   <name>${numberedName}</name>\n` +
        `   <tag></tag>\n` +
        `   <comment></comment>\n` +
        `   <recordOption>OTHER</recordOption>\n` +
        `   <testCaseGuid>${guid}</testCaseGuid>\n` +
        `</TestCaseEntity>`;

      testCases.push({ name: numberedName, tc, groovy });

      const div = document.createElement('div');
      div.innerHTML = `<strong>${numberedName}</strong><br>
        <button onclick="downloadGroovyZip('${numberedName}')\">.groovy ZIP ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadFile('${numberedName}', 'tc')\">.tc ë‹¤ìš´ë¡œë“œ</button><hr>`;
      container.appendChild(div);
    });
  };
  reader.readAsArrayBuffer(file);
});

function downloadGroovyZip(name) {
  const tc = testCases.find(t => t.name === name);
  const zip = new JSZip();
  const folder = zip.folder(tc.name);
  folder.file(`${tc.name}.groovy`, tc.groovy);
  zip.generateAsync({ type: 'blob' }).then(content => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = `${tc.name}.zip`;
    a.click();
  });
}

function downloadFile(name, type) {
  if (type === 'groovy') {
    downloadGroovyZip(name);
    return;
  }
  const tc = testCases.find(t => t.name === name);
  const content = tc[type];
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.${type}`;
  a.click();
}

function generateAllZip(type) {
  const zip = new JSZip();
  testCases.forEach(tc => {
    if (type === 'groovy') {
      const folder = zip.folder(tc.name);
      folder.file(`${tc.name}.groovy`, tc.groovy);
    } else {
      zip.file(`${tc.name}.tc`, tc.tc);
    }
  });
  zip.generateAsync({ type: 'blob' }).then(content => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = `all_testcases_${type}.zip`;
    a.click();
  });
}

function addInput(value = '') {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'í´ë”ëª… ì…ë ¥';
  input.value = value;
  document.getElementById('inputArea').appendChild(document.createElement('br'));
  document.getElementById('inputArea').appendChild(input);
}

function generateZip() {
  const zip = new JSZip();
  const inputs = document.querySelectorAll('#inputArea input');
  let folderAdded = false;

  inputs.forEach(input => {
    const folderName = input.value.trim();
    if (folderName) {
      zip.folder(folderName + '/');
      folderAdded = true;
    }
  });

  if (!folderAdded) {
    alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ í´ë”ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  zip.generateAsync({ type: "blob" }).then(blob => {
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "í´ë”ëª¨ìŒ.zip";
    link.click();
  });
}

document.getElementById('excelInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

    if (rows.length === 0) {
      alert('ì—‘ì…€ íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
      return;
    }

    // Summary ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
    const headerRow = rows[0];
    const summaryIndex = headerRow.indexOf('Summary');
    if (summaryIndex === -1) {
      alert("'Summary'ë¼ëŠ” ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    // ê¸°ì¡´ input ì´ˆê¸°í™”
    document.getElementById('inputArea').innerHTML = '';

    // Summaryê°€ ìˆëŠ” í–‰ ì „ì²´ë¥¼ í´ë”ëª…ìœ¼ë¡œ ì§€ì •
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      const folderName = row[summaryIndex];
      if (folderName) {
        // í•„ìš”í•˜ë‹¤ë©´ row ì „ì²´ë¥¼ í™œìš©í•´ í´ë”ëª… ìƒì„± ê°€ëŠ¥
        addInput(folderName);
      }
    }

    if (document.querySelectorAll('#inputArea input').length === 0) {
      addInput('');
    }
  };
  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
